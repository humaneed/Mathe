<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1a5c3a">
  <title>Mathe √ºben</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    /* Design-Award inspiriertes Farbschema */
    :root {
      --color-primary: #7BA591;        /* Salbeigr√ºn - beruhigend */
      --color-primary-dark: #5D8A75;
      --color-primary-light: #A8C9B8;
      --color-accent: #E8B86D;          /* Warmes Gold */
      --color-accent-dark: #D4A055;
      --color-success: #88B894;
      --color-error: #D4816F;
      --color-text: #3D4F42;
      --color-text-light: #6B7C70;
      --color-bg: #F9F7F4;              /* Warmes Wei√ü */
      --color-surface: #FFFFFF;
      --color-border: #E3DED7;
      --shadow-sm: 0 2px 8px rgba(61, 79, 66, 0.08);
      --shadow-md: 0 4px 16px rgba(61, 79, 66, 0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --font-display: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Roboto', sans-serif;
      --font-body: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', 'Roboto', sans-serif;
    }
    
    /* PWA-√§hnliche Optimierungen */
    html {
      height: 100%;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body { 
      font-family: var(--font-body);
      background: radial-gradient(circle at top, #e7f0ea 0, #f9f7f4 45%, #f3eee6 100%);
      height: 100vh;
      height: 100dvh; /* Dynamic viewport height f√ºr Mobile */
      overflow: hidden;
      padding: 0;
      color: var(--color-text);
      position: fixed;
      width: 100%;
      -webkit-overflow-scrolling: touch;
      font-weight: 400;
      letter-spacing: 0.01em;
      line-height: 1.6;
    }
    
    /* Scrollbarer Container f√ºr den Inhalt */
    .app-wrapper {
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .container { 
      max-width: 900px; 
      margin: 0 auto;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      -webkit-overflow-scrolling: touch;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      background: rgba(255, 255, 255, 0.96);
      padding: 16px;
      padding-top: calc(16px + env(safe-area-inset-top));
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 100;
      flex-shrink: 0;
      border-bottom: 1px solid var(--color-border);
      backdrop-filter: blur(12px);
    }
    
    .logo { 
      font-size: 1.35rem; 
      font-weight: 600;
      color: var(--color-primary-dark);
      white-space: nowrap;
      letter-spacing: -0.02em;
      font-family: var(--font-display);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .logo span {
      font-size: 1.4rem;
    }
    
    .stats {
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .stats::-webkit-scrollbar {
      display: none;
    }
    
    .stat-box {
      background: var(--color-primary-light);
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--color-primary-dark);
      border: 1px solid var(--color-primary);
      white-space: nowrap;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .stat-value { 
      font-weight: 600; 
      margin-left: 2px; 
      color: var(--color-primary-dark);
      font-feature-settings: 'tnum';
      font-variant-numeric: tabular-nums;
      transition: transform 0.15s ease-out;
    }

    .stat-value.bump {
      transform: scale(1.1);
    }
    
    .card { 
      background: var(--color-surface);
      border-radius: var(--radius-lg); 
      padding: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--color-border);
      margin-bottom: 16px;
    }
    
    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }
    
    .grades { display: flex; gap: 8px; flex-wrap: wrap; }
    
    .grades button { 
      padding: 10px 16px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--color-text);
      transition: var(--transition);
    }
    
    .grades button:hover {
      background: var(--color-bg);
      border-color: var(--color-primary);
    }
    
    .grades button.on { 
      background: var(--color-primary);
      border-color: var(--color-primary-dark);
      color: var(--color-surface);
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.6);
    }
    
    .icon-btn {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-md);
      border: 2px solid var(--color-border);
      background: var(--color-surface);
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--color-text);
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .icon-btn:hover {
      background: var(--color-bg);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    .task-area {
      background: var(--color-bg);
      border-radius: var(--radius-md);
      padding: 32px;
      text-align: center;
      margin-bottom: 20px;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--color-border);
    }
    
    .task-text { 
      font-size: clamp(2rem, 10vw, 3.2rem);
      font-weight: 600;
      color: var(--color-text);
      text-align: center;
      margin: 36px 0;
      line-height: 1.2;
      font-family: var(--font-display);
      letter-spacing: -0.03em;
      font-feature-settings: 'tnum';
      font-variant-numeric: tabular-nums;
    }
    
    .answers { 
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .answers button { 
      padding: 24px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      background: var(--color-surface);
      font-size: 1.5rem;
      font-weight: 600;
      cursor: pointer;
      color: var(--color-text);
      transition: var(--transition);
    }
    
    .answers button:hover {
      background: var(--color-bg);
      border-color: var(--color-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .answers button.ok { 
      background: var(--color-success);
      border-color: var(--color-success);
      color: var(--color-surface);
    }
    
    .answers button.no { 
      background: var(--color-error);
      border-color: var(--color-error);
      color: var(--color-surface);
    }
    
    .msg { 
      text-align: center;
      padding: 16px;
      border-radius: var(--radius-md);
      margin-bottom: 20px;
      font-weight: 600;
      font-size: 1.1rem;
      background: var(--color-bg);
      border: 2px solid var(--color-border);
      color: var(--color-text);
    }
    
    .msg.ok { 
      background: var(--color-success);
      border-color: var(--color-success);
      color: #22543d;
    }
    
    .msg.no { 
      background: #fed7d7;
      border-color: #fc8181;
      color: #742a2a;
    }
    
    .btns { 
      display: grid;
      grid-template-columns: auto auto 1fr;
      gap: 12px;
    }
    
    .btns button { 
      padding: 18px 28px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      background: var(--color-surface);
      color: var(--color-text);
      transition: var(--transition);
      letter-spacing: 0.01em;
    }
    
    .btns button:hover {
      background: var(--color-bg);
      border-color: var(--color-primary);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    .btns .main { 
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: var(--color-surface);
      font-weight: 600;
    }
    
    .btns .main:hover {
      background: var(--color-primary-dark);
      border-color: var(--color-primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .btns .help:disabled { 
      opacity: 0.4; 
      cursor: not-allowed; 
    }
    
    .timer {
      position: absolute;
      top: 12px;
      right: 12px;
      background: var(--color-surface);
      padding: 8px 16px;
      border-radius: var(--radius-md);
      font-weight: 600;
      color: var(--color-primary-dark);
      font-size: 1.1rem;
      border: 1px solid var(--color-primary);
    }
    
    .timer.warning { 
      background: #fed7d7; 
      color: #742a2a; 
      border-color: #fc8181;
    }
    
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(61, 79, 66, 0.6);
      backdrop-filter: blur(4px);
      align-items: flex-end;
      justify-content: center;
      z-index: 1000;
      padding: 0;
    }
    
    .modal.show { display: flex; }
    
    .modal-content {
      background: var(--color-surface);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      max-width: 700px;
      width: 100%;
      max-height: 92vh;
      max-height: 92dvh;
      overflow: hidden;
      box-shadow: 0 -10px 40px rgba(61, 79, 66, 0.15);
      display: flex;
      flex-direction: column;
      animation: slideUp 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      position: relative;
      background: var(--color-bg);
    }
    
    .modal-header::before {
      content: '';
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: 36px;
      height: 4px;
      background: var(--color-border);
      border-radius: var(--radius-sm);
    }
    
    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text);
      margin-top: 12px;
      font-family: var(--font-display);
      letter-spacing: -0.01em;
    }
    
    .modal-close {
      background: var(--color-bg);
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--color-text-light);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-md);
      margin-top: 12px;
      transition: var(--transition);
    }
    
    .modal-close:hover {
      background: var(--color-surface);
    }
    
    .modal-body {
      padding: 16px;
      color: var(--color-text);
      overflow-y: auto;
      flex: 1;
      -webkit-overflow-scrolling: touch;
    }
    
    .modal-footer {
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      border-top: 2px solid var(--color-border);
      display: flex;
      justify-content: stretch;
      flex-shrink: 0;
      background: var(--color-surface);
    }
    
    .modal-footer button {
      padding: 14px 24px;
      background: var(--color-primary);
      border: 2px solid var(--color-primary-dark);
      border-radius: var(--radius-lg);
      color: var(--color-surface);
      font-weight: 600;
      cursor: pointer;
      font-size: 1.05rem;
      width: 100%;
      min-height: 48px;
      transition: var(--transition);
    }
    
    .modal-footer button:hover {
      background: var(--color-primary-dark);
    }
    
    .modal-footer button:active {
      transform: scale(0.985);
    }
    
    .history { margin-top: 12px; }
    
    .history-item {
      padding: 10px 14px;
      margin-bottom: 8px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      border: 2px solid;
    }
    
    .history-item.ok {
      background: var(--color-success);
      border-color: var(--color-success);
      color: #22543d;
    }
    
    .history-item.no {
      background: #fed7d7;
      border-color: #fc8181;
      color: #742a2a;
    }
    
    .settings-panel {
      background: var(--color-bg);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--color-border);
    }
    
    .setting-row:last-child { border-bottom: none; }
    
    .setting-label {
      font-weight: 600;
      color: #4a5568;
    }
    
    .toggle {
      width: 56px;
      height: 28px;
      background: var(--color-border);
      border-radius: 14px;
      position: relative;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .toggle::after {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      background: var(--color-surface);
      border-radius: var(--radius-md);
      top: 3px;
      left: 3px;
      transition: all 0.3s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    }
    
    .toggle.on {
      background: var(--color-success);
    }
    
    .toggle.on::after {
      left: 31px;
    }
    
    .calculation {
      background: var(--color-bg);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 20px;
      margin: 16px 0;
      font-family: 'Courier New', monospace;
      font-size: 1.2rem;
      text-align: center;
    }
    
    .step {
      background: var(--color-surface);
      border-left: 4px solid #2c5282;
      padding: 12px 16px;
      margin: 12px 0;
      border-radius: 4px;
    }
    
    .step-number {
      font-weight: 600;
      color: var(--color-primary-dark);
      margin-bottom: 6px;
    }
    
    .step-content {
      color: var(--color-text);
      line-height: 1.6;
    }
    
    .result-highlight {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--color-surface);
      padding: 16px;
      border-radius: var(--radius-md);
      text-align: center;
      font-weight: 600;
      font-size: 1.2rem;
      margin: 16px 0;
    }
    
    .tip-box {
      background: var(--color-surface);
      border: 2px solid #ffc107;
      border-radius: var(--radius-md);
      padding: 12px 16px;
      margin-top: 16px;
      color: #856404;
      font-weight: 600;
    }
    
    .written-calc {
      font-family: 'Courier New', monospace;
      font-size: 1.3rem;
      line-height: 1.8;
      background: var(--color-surface);
      border: 2px solid #2c5282;
      border-radius: var(--radius-md);
      padding: 20px;
      margin: 16px 0;
      display: inline-block;
      min-width: 200px;
    }
    
    .written-calc-row {
      text-align: right;
      padding: 4px 0;
    }
    
    .written-calc-line {
      border-top: 2px solid var(--color-text);
      margin: 8px 0;
      padding-top: 8px;
    }
    
    .carry {
      color: var(--color-primary-dark);
      font-size: 0.85em;
      vertical-align: super;
    }
    
    .highlight-step {
      background: #fef3c7;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
    }
    
    /* Touch-Optimierungen f√ºr alle Buttons */
    button {
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
      touch-action: manipulation;
      outline: none;
    }
    
    button:active {
      transform: scale(0.985);
    }

    button:focus-visible {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }
    
    /* 9:16 Mobile Optimierungen */
    @media (max-width: 640px) {
      .container {
        padding: 8px;
      }
      
      .card {
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 16px;
      }
      
      .logo {
        font-size: 1.1rem;
      }
      
      .stat-box {
        font-size: 0.8rem;
        padding: 4px 10px;
      }
      
      .task-text { 
        font-size: clamp(1.5rem, 8vw, 2.2rem);
        margin: 16px 0;
      }
      
      .answers { 
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .answers button {
        min-height: 52px;
        font-size: 1.1rem;
      }
      
      .btns { 
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .btns button {
        min-height: 48px;
        font-size: 1rem;
      }
      
      .controls { 
        flex-direction: column; 
        align-items: stretch;
        gap: 12px;
      }
      
      .grades { 
        justify-content: stretch;
        gap: 6px;
      }
      
      .grades button {
        flex: 1;
        font-size: 0.9rem;
        padding: 10px 8px;
      }
      
      /* Modal spezifisch f√ºr Mobile */
      .modal-content {
        max-height: 95vh;
        max-height: 95dvh;
      }
      
      .modal-body {
        padding: 12px;
      }
      
      .modal-title {
        font-size: 1.1rem;
      }
    }
    
    /* Extra optimiert f√ºr sehr schmale Ger√§te (typisch 9:16) */
    @media (max-width: 380px) {
      .logo {
        font-size: 1rem;
      }
      
      .stat-box {
        font-size: 0.75rem;
        padding: 4px 8px;
      }
      
      .grades button {
        font-size: 0.85rem;
        padding: 8px 6px;
      }
      
      .icon-btn {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <div class="header">
      <div class="logo"><span>üßÆ</span>Mathe √ºben</div>
      <div class="stats">
        <div class="stat-box">Punkte: <span class="stat-value" id="score">0</span></div>
        <div class="stat-box">Gesamt: <span class="stat-value" id="total">0</span></div>
        <div class="stat-box">üî• Serie: <span class="stat-value" id="streak">0</span></div>
      </div>
    </div>
    
    <div class="container">
      <div class="card">
        <div class="controls">
          <div class="grades" id="grades">
            <button data-g="1" class="on">1. Klasse</button>
            <button data-g="2">2. Klasse</button>
            <button data-g="3">3. Klasse</button>
            <button data-g="4">4. Klasse</button>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="icon-btn" id="snd">üîä</button>
            <button class="icon-btn" id="history-btn">üìä</button>
            <button class="icon-btn" id="settings">‚öôÔ∏è</button>
          </div>
        </div>
        
        <div style="position: relative;">
          <div class="timer" id="timer" style="display: none;">‚è±Ô∏è <span id="time">30</span>s</div>
          <div class="task-area">
            <div class="task-text" id="task">Klicke auf "Neue Aufgabe"</div>
          </div>
        </div>
        
        <div class="answers" id="ans"></div>
        
        <div class="msg" id="msg">W√§hle eine Klassenstufe und klicke auf "Neue Aufgabe"</div>
        
        <div class="history" id="history"></div>
        
        <div class="btns">
          <button class="help" id="help" disabled>üí° Erkl√§rung</button>
          <button id="history-btn-2">üìä Verlauf</button>
          <button class="main" id="start">Neue Aufgabe</button>
        </div>
      </div>
    </div><!-- .container -->
  </div><!-- .app-wrapper -->
  
  <!-- Modals (au√üerhalb der App-Struktur) -->
  <div class="modal" id="ov-help">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">üí° Erkl√§rung</div>
        <button class="modal-close" id="cls-help">√ó</button>
      </div>
      <div class="modal-body" id="mbody-help"></div>
      <div class="modal-footer">
        <button id="mok-help">Verstanden</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="ov-settings">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">‚öôÔ∏è Einstellungen</div>
        <button class="modal-close" id="cls-settings">√ó</button>
      </div>
      <div class="modal-body">
        <div class="settings-panel">
          <div class="setting-row">
            <div class="setting-label">Timer (30s)</div>
            <div class="toggle" id="toggle-timer"></div>
          </div>
          <div class="setting-row">
            <div class="setting-label">Sprachausgabe</div>
            <div class="toggle on" id="toggle-sound"></div>
          </div>
          <div class="setting-row">
            <div class="setting-label">Tastatur (1-4, Enter, E)</div>
            <div class="toggle on" id="toggle-keys"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="mok-settings">Schlie√üen</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="ov-history">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">üìä Deine Statistiken</div>
        <button class="modal-close" id="cls-history">√ó</button>
      </div>
      <div class="modal-body" id="mbody-history"></div>
      <div class="modal-footer">
        <button id="mok-history">Schlie√üen</button>
      </div>
    </div>
  </div>

<script>
const $ = id => document.getElementById(id);

const state = {
  grade: 1,
  score: 0,
  total: 0,
  streak: 0,
  maxStreak: 0,
  currentTask: null,
  answered: false,
  history: [],
  settings: { timer: false, sound: true, keyboard: true },
  voice: null,
  timerValue: 30,
  timerInterval: null
};

const synth = 'speechSynthesis' in window ? window.speechSynthesis : null;

// Aufgabengenerierung
// Zufallszahl
function rand(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

// Hilfsfunktionen f√ºr "schlauere" Aufgaben
function choice(arr) {
  return arr[rand(0, arr.length - 1)];
}

function shuffleOptions(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

/**
 * Erzeuge Antwortoptionen rund um die richtige L√∂sung:
 * - Nah dran (typische Rechenfehler)
 * - Alle positiv und im sinnvollen Bereich
 */
function buildOptions(answer, cfg = {}) {
  const min = cfg.min ?? 0;
  const max = cfg.max ?? 9999;
  const spread = cfg.spread ?? Math.max(3, Math.round((max - min) / 10));

  const set = new Set();
  set.add(answer);

  let guard = 0;
  // typische ‚Äûknapp daneben‚Äú-Fehler
  while (set.size < 4 && guard < 50) {
    guard++;
    let delta = rand(-spread, spread);
    if (delta === 0) continue;
    let wrong = answer + delta;
    if (wrong < min || wrong > max) continue;
    set.add(wrong);
  }

  // notfalls auff√ºllen
  guard = 0;
  while (set.size < 4 && guard < 50) {
    guard++;
    let wrong = rand(min, max);
    if (wrong === answer) continue;
    set.add(wrong);
  }

  const options = shuffleOptions(Array.from(set));
  return { options, correctIndex: options.indexOf(answer) };
}

/**
 * Addition mit optionalem Zehner√ºbergang
 */
function makeAddition(config) {
  const {
    minA, maxA,
    minB, maxB,
    sumMin = null,
    sumMax = null,
    requireBridge = false
  } = config;

  let attempts = 0;
  while (attempts < 50) {
    attempts++;
    let a = rand(minA, maxA);
    let b = rand(minB, maxB);
    let s = a + b;

    if (sumMin !== null && s < sumMin) continue;
    if (sumMax !== null && s > sumMax) continue;
    if (requireBridge && ((a % 10) + (b % 10) < 10)) continue; // kein Zehner√ºbergang

    return { num1: a, num2: b, answer: s };
  }

  // Fallback
  let a = rand(minA, maxA);
  let b = rand(minB, maxB);
  return { num1: a, num2: b, answer: a + b };
}

/**
 * Subtraktion mit optionalem ‚ÄûBorgen‚Äú
 */
function makeSubtraction(config) {
  const {
    minResult,
    maxResult,
    minSub = 1,
    maxSub = null,
    requireBorrow = false
  } = config;

  let attempts = 0;
  while (attempts < 50) {
    attempts++;
    let result = rand(minResult, maxResult);
    let sub = rand(minSub, maxSub ?? result);
    if (sub > result) {
      // vertauschen, damit Ergebnis positiv bleibt
      [sub, result] = [result, sub];
    }
    const minuend = result + sub;

    if (requireBorrow && (minuend % 10) >= (sub % 10)) {
      // wir wollen, dass hinten ‚Äûgeborgt‚Äú werden muss (z.B. 42 - 7)
      continue;
    }

    return { num1: minuend, num2: sub, answer: result };
  }

  // Fallback
  let result = rand(minResult, maxResult);
  let sub = rand(minSub, result);
  const minuend = result + sub;
  return { num1: minuend, num2: sub, answer: result };
}

/**
 * Kern-Aufgabengenerator pro Klassenstufe
 * - Klasse 1: Zahlzerlegungen + einfache Plus/Minus
 * - Klasse 2: Plus/Minus bis 100 mit Zehner√ºbergang, erstes Einmaleins
 * - Klasse 3: gr√∂√üere Zahlen, Multiplikation & Division aus dem Einmaleins
 * - Klasse 4: dreistellige Zahlen, schwierigere Mal- und Geteiltaufgaben
 */
function createTask(grade) {
  let num1, num2, answer, op, symbol;

  // --- Aufgaben nach Klasse ---
  if (grade === 1) {
    const r = Math.random();
    if (r < 0.5) {
      // Zahlzerlegung: a + b = 10 (oder 6‚Äì10)
      answer = rand(5, 10);
      num1 = rand(1, answer - 1);
      num2 = answer - num1;
      op = 'add';
      symbol = '+';
    } else if (r < 0.8) {
      // Addition bis 20 (oft mit Zehner√ºbergang)
      const cfg = makeAddition({
        minA: 2, maxA: 15,
        minB: 2, maxB: 15,
        sumMin: 6, sumMax: 20,
        requireBridge: Math.random() < 0.6
      });
      num1 = cfg.num1;
      num2 = cfg.num2;
      answer = cfg.answer;
      op = 'add';
      symbol = '+';
    } else {
      // Subtraktion mit kleinem Ergebnis
      const cfg = makeSubtraction({
        minResult: 1,
        maxResult: 10,
        minSub: 1,
        requireBorrow: false
      });
      num1 = cfg.num1;
      num2 = cfg.num2;
      answer = cfg.answer;
      op = 'sub';
      symbol = '‚àí';
    }
  } else if (grade === 2) {
    const r = Math.random();
    if (r < 0.4) {
      // Addition bis 100 mit Zehner√ºbergang
      const cfg = makeAddition({
        minA: 10, maxA: 80,
        minB: 10, maxB: 80,
        sumMin: 20, sumMax: 100,
        requireBridge: true
      });
      num1 = cfg.num1;
      num2 = cfg.num2;
      answer = cfg.answer;
      op = 'add';
      symbol = '+';
    } else if (r < 0.8) {
      // Subtraktion bis 100, h√§ufig mit ‚ÄûBorgen‚Äú
      const cfg = makeSubtraction({
        minResult: 5,
        maxResult: 90,
        minSub: 3,
        requireBorrow: Math.random() < 0.7
      });
      num1 = cfg.num1;
      num2 = cfg.num2;
      answer = cfg.answer;
      op = 'sub';
      symbol = '‚àí';
    } else {
      // Kleines Einmaleins
      num1 = rand(2, 10);
      num2 = rand(2, 10);
      answer = num1 * num2;
      op = 'mul';
      symbol = '√ó';
    }
  } else if (grade === 3) {
    const r = Math.random();
    if (r < 0.35) {
      // Plus mit 2-stelligen / 3-stelligen Zahlen
      const cfg = makeAddition({
        minA: 20, maxA: 150,
        minB: 20, maxB: 150,
        sumMin: 40, sumMax: 200,
        requireBridge: true
      });
      num1 = cfg.num1;
      num2 = cfg.num2;
      answer = cfg.answer;
      op = 'add';
      symbol = '+';
    } else if (r < 0.7) {
      // Minus mit ‚ÄûBorgen‚Äú
      const cfg = makeSubtraction({
        minResult: 10,
        maxResult: 150,
        minSub: 5,
        requireBorrow: Math.random() < 0.8
      });
      num1 = cfg.num1;
      num2 = cfg.num2;
      answer = cfg.answer;
      op = 'sub';
      symbol = '‚àí';
    } else if (r < 0.9) {
      // 2-stellig √ó 1-stellig
      num1 = rand(12, 99);
      num2 = rand(2, 9);
      answer = num1 * num2;
      op = 'mul';
      symbol = '√ó';
    } else {
      // Division aus dem Einmaleins
      num2 = rand(2, 12);
      answer = rand(2, 12);
      num1 = num2 * answer;
      op = 'div';
      symbol = '√∑';
    }
  } else {
    // Klasse 4
    const r = Math.random();
    if (r < 0.3) {
      // 3-stellige Addition
      const cfg = makeAddition({
        minA: 100, maxA: 999,
        minB: 100, maxB: 999,
        sumMin: 200, sumMax: 1800,
        requireBridge: true
      });
      num1 = cfg.num1;
      num2 = cfg.num2;
      answer = cfg.answer;
      op = 'add';
      symbol = '+';
    } else if (r < 0.6) {
      // 3-stellige Subtraktion
      const cfg = makeSubtraction({
        minResult: 50,
        maxResult: 900,
        minSub: 20,
        requireBorrow: true
      });
      num1 = cfg.num1;
      num2 = cfg.num2;
      answer = cfg.answer;
      op = 'sub';
      symbol = '‚àí';
    } else if (r < 0.8) {
      // Etwas schwierigere Multiplikation (2-stellig √ó 2-stellig)
      num1 = rand(12, 99);
      num2 = rand(12, 25);
      answer = num1 * num2;
      op = 'mul';
      symbol = '√ó';
    } else {
      // Division mit 2-stelligem Ergebnis
      num2 = rand(2, 25);
      answer = rand(10, 50);
      num1 = num2 * answer;
      op = 'div';
      symbol = '√∑';
    }
  }

  // Mit kleiner Wahrscheinlichkeit Sachaufgaben bevorzugen (ab Klasse 2 h√§ufiger)
  const useWordTaskChance = grade >= 2 ? 0.25 : 0.1;
  if (Math.random() < useWordTaskChance) {
    return createWordTask(grade);
  }

  const { options, correctIndex } = buildOptions(answer, {
    min: 0,
    max: grade <= 2 ? 120 : 2500,
    spread: grade === 1 ? 5 : grade === 2 ? 10 : 30
  });

  return {
    num1,
    num2,
    answer,
    op,
    problem: `${num1} ${symbol} ${num2} = ?`,
    options,
    correctIndex,
    taskType: 'math'
  };
}

/**
 * Sachaufgaben je nach Klassenstufe
 * (nutzt weiterhin op/num1/num2/answer, damit deine Erkl√§rung-Logik passt)
 */
function createWordTask(grade) {
  const templates = [
    // --- Klasse 1‚Äì2: sehr einfache Geschichten ---
    {
      minGrade: 1,
      maxGrade: 2,
      op: 'add',
      min1: 1,
      max1: 10,
      min2: 1,
      max2: 10,
      text: 'Lina hat {n1} Murmeln. Sie findet {n2} Murmeln dazu. Wie viele Murmeln hat sie jetzt insgesamt?'
    },
    {
      minGrade: 1,
      maxGrade: 2,
      op: 'sub',
      min1: 5,
      max1: 15,
      min2: 1,
      max2: 8,
      text: 'Ben hat {n1} Baukl√∂tze. Er gibt {n2} Baukl√∂tze an seine Freundin ab. Wie viele Baukl√∂tze bleiben Ben?'
    },
    {
      minGrade: 2,
      maxGrade: 3,
      op: 'add',
      min1: 10,
      max1: 60,
      min2: 5,
      max2: 40,
      text: 'In einer Klasse sitzen {n1} Kinder. In der Parallelklasse sitzen {n2} Kinder. Wie viele Kinder sind das zusammen?'
    },
    // --- Klasse 2‚Äì3: Einmaleins / Gruppen ---
    {
      minGrade: 2,
      maxGrade: 3,
      op: 'mul',
      min1: 2,
      max1: 10,
      min2: 2,
      max2: 10,
      text: 'Auf jedem Teller liegen {n1} Kekse. Es gibt {n2} Teller. Wie viele Kekse sind das insgesamt?'
    },
    {
      minGrade: 3,
      maxGrade: 4,
      op: 'mul',
      min1: 3,
      max1: 12,
      min2: 2,
      max2: 9,
      text: 'Ein Bus hat {n1} Sitzpl√§tze pro Reihe. Es gibt {n2} Reihen. Wie viele Sitzpl√§tze gibt es insgesamt im Bus?'
    },
    // --- Klasse 3‚Äì4: Division als faires Aufteilen ---
    {
      minGrade: 3,
      maxGrade: 4,
      op: 'div',
      divMinFriends: 2,
      divMaxFriends: 8,
      divMinEach: 2,
      divMaxEach: 12,
      text: 'Es gibt {n1} Bonbons. Sie sollen gerecht auf {n2} Kinder verteilt werden. Wie viele Bonbons bekommt jedes Kind?'
    },
    // --- Klasse 4: Geld / gr√∂√üere Zahlen ---
    {
      minGrade: 4,
      maxGrade: 4,
      op: 'add',
      min1: 120,
      max1: 480,
      min2: 50,
      max2: 320,
      text: 'Ein Ausflug kostet f√ºr die Busfahrt {n1} Euro und f√ºr den Eintritt {n2} Euro. Wie viel kostet der Ausflug insgesamt?'
    },
    {
      minGrade: 4,
      maxGrade: 4,
      op: 'sub',
      min1: 150,
      max1: 500,
      min2: 20,
      max2: 140,
      text: 'Mara hat {n1} Euro gespart. Sie kauft sich ein Spiel f√ºr {n2} Euro. Wie viel Geld hat sie danach noch √ºbrig?'
    }
  ];

  const usable = templates.filter(t => grade >= t.minGrade && grade <= t.maxGrade);
  const t = choice(usable.length ? usable : templates);

  let num1, num2, answer, op = t.op;

  if (t.op === 'div') {
    // Spezialfall: wir steuern √ºber ‚ÄûKinder‚Äú (divisor) + ‚ÄûBonbons pro Kind‚Äú (quotient)
    const friends = rand(t.divMinFriends, t.divMaxFriends);
    const each = rand(t.divMinEach, t.divMaxEach);
    num2 = friends;        // Teiler
    answer = each;         // Ergebnis
    num1 = friends * each; // Dividend
  } else if (t.op === 'mul') {
    num1 = rand(t.min1, t.max1);
    num2 = rand(t.min2, t.max2);
    answer = num1 * num2;
  } else if (t.op === 'add') {
    num1 = rand(t.min1, t.max1);
    num2 = rand(t.min2, t.max2);
    answer = num1 + num2;
  } else {
    // sub
    const cfg = makeSubtraction({
      minResult: t.min1,
      maxResult: t.max1,
      minSub: t.min2,
      maxSub: t.max2,
      requireBorrow: grade >= 3
    });
    num1 = cfg.num1;
    num2 = cfg.num2;
    answer = cfg.answer;
  }

  let text = t.text
    .replace('{n1}', num1)
    .replace('{n2}', num2);

  const { options, correctIndex } = buildOptions(answer, {
    min: 0,
    max: grade <= 2 ? 120 : 1000,
    spread: grade === 1 ? 5 : grade === 2 ? 10 : 25
  });

  return {
    num1,
    num2,
    answer,
    op,
    problem: text,
    options,
    correctIndex,
    taskType: 'word'
  };
}
// Schriftliche Addition
function generateWrittenAddition(num1, num2, sum) {
  const str1 = String(num1);
  const str2 = String(num2);
  const maxLen = Math.max(str1.length, str2.length);
  
  const pad1 = str1.padStart(maxLen, ' ');
  const pad2 = str2.padStart(maxLen, ' ');
  
  let html = '<div class="written-calc">';
  html += '<div class="written-calc-row" style="text-align: right; padding-right: 30px;">';
  
  // Erste Zahl mit √úbertr√§gen
  let carries = [];
  let currentCarry = 0;
  
  for (let i = maxLen - 1; i >= 0; i--) {
    const d1 = pad1[i] === ' ' ? 0 : parseInt(pad1[i]);
    const d2 = pad2[i] === ' ' ? 0 : parseInt(pad2[i]);
    const digitSum = d1 + d2 + currentCarry;
    
    if (digitSum >= 10) {
      carries[i] = 1;
      currentCarry = 1;
    } else {
      carries[i] = 0;
      currentCarry = 0;
    }
  }
  
  // Zeige √úbertr√§ge
  for (let i = 0; i < maxLen; i++) {
    if (carries[i] === 1) {
      html += `<span class="carry">¬π</span>`;
    } else {
      html += '<span style="visibility: hidden;">¬π</span>';
    }
  }
  html += '</div>';
  
  html += `<div class="written-calc-row">  ${pad1}</div>`;
  html += `<div class="written-calc-row">+ ${pad2}</div>`;
  html += `<div class="written-calc-row written-calc-line">= ${sum}</div>`;
  html += '</div>';
  
  // Schrittweise Erkl√§rung
  html += '<div style="margin-top: 20px;">';
  html += '<strong>Schritt f√ºr Schritt:</strong>';
  
  currentCarry = 0;
  let stepNum = 1;
  
  for (let i = maxLen - 1; i >= 0; i--) {
    const d1 = pad1[i] === ' ' ? 0 : parseInt(pad1[i]);
    const d2 = pad2[i] === ' ' ? 0 : parseInt(pad2[i]);
    const position = ['Einer', 'Zehner', 'Hunderter', 'Tausender'][maxLen - 1 - i];
    
    html += '<div class="step">';
    html += `<div class="step-number">Schritt ${stepNum}:</div>`;
    html += '<div class="step-content">';
    
    if (currentCarry > 0) {
      html += `${position}: ${d1} + ${d2} + <span class="carry">1</span> (√úbertrag) = `;
      const digitSum = d1 + d2 + currentCarry;
      if (digitSum >= 10) {
        html += `<span class="highlight-step">${digitSum}</span> ‚Üí Schreibe ${digitSum % 10}, merke 1`;
        currentCarry = 1;
      } else {
        html += `<span class="highlight-step">${digitSum}</span>`;
        currentCarry = 0;
      }
    } else {
      html += `${position}: ${d1} + ${d2} = `;
      const digitSum = d1 + d2;
      if (digitSum >= 10) {
        html += `<span class="highlight-step">${digitSum}</span> ‚Üí Schreibe ${digitSum % 10}, merke 1`;
        currentCarry = 1;
      } else {
        html += `<span class="highlight-step">${digitSum}</span>`;
      }
    }
    
    html += '</div></div>';
    stepNum++;
  }
  
  html += '</div>';
  
  return html;
}

// Schriftliche Subtraktion
function generateWrittenSubtraction(num1, num2, diff) {
  const str1 = String(num1);
  const str2 = String(num2);
  const maxLen = Math.max(str1.length, str2.length);
  
  const pad1 = str1.padStart(maxLen, ' ');
  const pad2 = str2.padStart(maxLen, ' ');
  
  let html = '<div class="written-calc">';
  html += '<div class="written-calc-row" style="text-align: right; padding-right: 30px;">';
  
  // Berechne Borgen
  let borrows = [];
  let nums1 = pad1.split('').map(c => c === ' ' ? 0 : parseInt(c));
  
  for (let i = maxLen - 1; i >= 0; i--) {
    const d1 = nums1[i];
    const d2 = pad2[i] === ' ' ? 0 : parseInt(pad2[i]);
    
    if (d1 < d2) {
      borrows[i] = 1;
      nums1[i] += 10;
      if (i > 0) nums1[i - 1] -= 1;
    } else {
      borrows[i] = 0;
    }
  }
  
  // Zeige Borgen
  for (let i = 0; i < maxLen; i++) {
    if (borrows[i] === 1) {
      html += `<span class="carry" style="color: #e53e3e;">‚Åª¬π</span>`;
    } else {
      html += '<span style="visibility: hidden;">‚Åª¬π</span>';
    }
  }
  html += '</div>';
  
  html += `<div class="written-calc-row">  ${pad1}</div>`;
  html += `<div class="written-calc-row">‚àí ${pad2}</div>`;
  html += `<div class="written-calc-row written-calc-line">= ${diff}</div>`;
  html += '</div>';
  
  // Schrittweise Erkl√§rung
  html += '<div style="margin-top: 20px;">';
  html += '<strong>Schritt f√ºr Schritt:</strong>';
  
  nums1 = pad1.split('').map(c => c === ' ' ? 0 : parseInt(c));
  let stepNum = 1;
  
  for (let i = maxLen - 1; i >= 0; i--) {
    let d1 = nums1[i];
    const d2 = pad2[i] === ' ' ? 0 : parseInt(pad2[i]);
    const position = ['Einer', 'Zehner', 'Hunderter', 'Tausender'][maxLen - 1 - i];
    
    html += '<div class="step">';
    html += `<div class="step-number">Schritt ${stepNum}:</div>`;
    html += '<div class="step-content">';
    
    if (d1 < d2) {
      html += `${position}: ${d1} ist kleiner als ${d2} ‚Üí Borge 10 von der n√§chsten Stelle<br>`;
      html += `${d1} + 10 = ${d1 + 10}, dann ${d1 + 10} ‚àí ${d2} = <span class="highlight-step">${d1 + 10 - d2}</span>`;
      if (i > 0) {
        nums1[i - 1] -= 1;
        html += `<br><small>(N√§chste Stelle wird um 1 verringert)</small>`;
      }
    } else {
      html += `${position}: ${d1} ‚àí ${d2} = <span class="highlight-step">${d1 - d2}</span>`;
    }
    
    html += '</div></div>';
    stepNum++;
  }
  
  html += '</div>';
  
  return html;
}

// Schriftliche Multiplikation (verbessert mit Gittermethode)
function generateWrittenMultiplication(num1, num2, product) {
  const str1 = String(num1);
  const str2 = String(num2);
  
  // F√ºr gr√∂√üere Zahlen: Zeige Gittermethode
  if (str1.length >= 3 && str2.length >= 2) {
    return generateGridMultiplication(num1, num2, product);
  }
  
  if (str2.length === 1) {
    // Einfache Multiplikation mit einstelligem Multiplikator
    let html = '<div class="written-calc">';
    html += `<div class="written-calc-row">  ${str1}</div>`;
    html += `<div class="written-calc-row">√ó ${str2}</div>`;
    html += `<div class="written-calc-row written-calc-line">= ${product}</div>`;
    html += '</div>';
    
    html += '<div style="margin-top: 20px;">';
    html += '<strong>Schritt f√ºr Schritt:</strong>';
    
    let carry = 0;
    const multiplier = parseInt(str2);
    
    for (let i = str1.length - 1; i >= 0; i--) {
      const digit = parseInt(str1[i]);
      const position = ['Einer', 'Zehner', 'Hunderter'][str1.length - 1 - i];
      
      html += '<div class="step">';
      html += `<div class="step-number">Schritt ${str1.length - i}:</div>`;
      html += '<div class="step-content">';
      
      const prod = digit * multiplier + carry;
      
      if (carry > 0) {
        html += `${position}: ${digit} √ó ${multiplier} + ${carry} (√úbertrag) = <span class="highlight-step">${prod}</span>`;
      } else {
        html += `${position}: ${digit} √ó ${multiplier} = <span class="highlight-step">${prod}</span>`;
      }
      
      if (prod >= 10 && i > 0) {
        html += ` ‚Üí Schreibe ${prod % 10}, merke ${Math.floor(prod / 10)}`;
        carry = Math.floor(prod / 10);
      } else {
        carry = 0;
      }
      
      html += '</div></div>';
    }
    
    html += '</div>';
    return html;
  }
  
  // Mehrstufige Multiplikation
  let html = '<div class="written-calc">';
  html += `<div class="written-calc-row">    ${str1}</div>`;
  html += `<div class="written-calc-row">  √ó ${str2}</div>`;
  html += '<div class="written-calc-row" style="border-top: 2px solid var(--color-text); margin-top: 4px; padding-top: 4px;">Zwischenergebnisse:</div>';
  
  const partials = [];
  for (let i = str2.length - 1; i >= 0; i--) {
    const digit = parseInt(str2[i]);
    const partial = num1 * digit * Math.pow(10, str2.length - 1 - i);
    partials.push(partial);
    const zeros = '0'.repeat(str2.length - 1 - i);
    html += `<div class="written-calc-row">${partial}${zeros.length > partial.toString().length ? ' (√ó' + Math.pow(10, str2.length - 1 - i) + ')' : ''}</div>`;
  }
  
  html += '<div class="written-calc-row" style="border-top: 2px solid var(--color-text); margin-top: 4px; padding-top: 4px;">Summe:</div>';
  html += `<div class="written-calc-row">= ${product}</div>`;
  html += '</div>';
  
  html += '<div style="margin-top: 20px;">';
  html += '<strong>Schritt f√ºr Schritt:</strong>';
  
  for (let i = str2.length - 1, step = 1; i >= 0; i--, step++) {
    const digit = parseInt(str2[i]);
    const position = ['Einer', 'Zehner', 'Hunderter'][str2.length - 1 - i];
    const partial = num1 * digit;
    const multiplier = Math.pow(10, str2.length - 1 - i);
    
    html += '<div class="step">';
    html += `<div class="step-number">Schritt ${step}:</div>`;
    html += '<div class="step-content">';
    html += `${position} von ${num2}: ${num1} √ó ${digit}`;
    if (multiplier > 1) {
      html += ` √ó ${multiplier}`;
    }
    html += ` = <span class="highlight-step">${partial * multiplier}</span>`;
    html += '</div></div>';
  }
  
  html += '<div class="step">';
  html += `<div class="step-number">Letzter Schritt:</div>`;
  html += '<div class="step-content">';
  html += 'Addiere alle Zwischenergebnisse:<br>';
  html += partials.join(' + ') + ` = <span class="highlight-step">${product}</span>`;
  html += '</div></div>';
  
  html += '</div>';
  
  return html;
}

// Gittermethode f√ºr Multiplikation (K√§stchen-Darstellung)
function generateGridMultiplication(num1, num2, product) {
  const str1 = String(num1);
  const str2 = String(num2);
  
  let html = '<div style="margin: 20px 0;">';
  html += '<strong>üî¢ Gittermethode (K√§stchen-Multiplikation):</strong>';
  html += '</div>';
  
  // Erstelle das Gitter
  html += '<div style="display: inline-block; border: 2px solid #2c5282; background: var(--color-surface);">';
  html += '<table style="border-collapse: collapse; font-family: monospace; font-size: 1.1rem;">';
  
  // Kopfzeile mit den Ziffern von num1
  html += '<tr><td style="padding: 8px; border: 1px solid var(--color-border);"></td>';
  for (let i = 0; i < str1.length; i++) {
    html += `<td style="padding: 8px; border: 1px solid var(--color-border); text-align: center; background: var(--color-primary-light); font-weight: 600;">${str1[i]}</td>`;
  }
  html += '</tr>';
  
  // F√ºr jede Ziffer von num2
  for (let j = 0; j < str2.length; j++) {
    html += '<tr>';
    html += `<td style="padding: 8px; border: 1px solid var(--color-border); text-align: center; background: var(--color-primary-light); font-weight: 600;">${str2[j]}</td>`;
    
    // F√ºr jede Ziffer von num1
    for (let i = 0; i < str1.length; i++) {
      const digit1 = parseInt(str1[i]);
      const digit2 = parseInt(str2[j]);
      const prod = digit1 * digit2;
      const tens = Math.floor(prod / 10);
      const ones = prod % 10;
      
      html += '<td style="padding: 4px; border: 1px solid var(--color-border); width: 50px; height: 50px; position: relative;">';
      html += '<div style="position: relative; width: 100%; height: 100%;">';
      html += '<div style="position: absolute; top: 2px; left: 4px; font-size: 0.9rem; color: var(--color-primary-dark); font-weight: 600;">' + (tens > 0 ? tens : '') + '</div>';
      html += '<div style="position: absolute; bottom: 2px; right: 4px; font-size: 0.9rem; color: var(--color-primary-dark); font-weight: 600;">' + ones + '</div>';
      html += '<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-left: 1px solid #a0aec0; transform: rotate(45deg); transform-origin: top left;"></div>';
      html += '</div>';
      html += '</td>';
    }
    html += '</tr>';
  }
  
  html += '</table>';
  html += '</div>';
  
  // Erkl√§rung der Diagonalen-Addition
  html += '<div style="margin-top: 24px;">';
  html += '<strong>So rechnest du das Ergebnis aus:</strong>';
  html += '</div>';
  
  html += '<div class="step">';
  html += '<div class="step-number">Schritt 1: Multiplizieren</div>';
  html += '<div class="step-content">';
  html += 'Jede Ziffer wird mit jeder anderen multipliziert. Das Ergebnis wird in das K√§stchen eingetragen:<br>';
  html += `<strong>Zehner</strong> oben links, <strong>Einer</strong> unten rechts`;
  html += '</div></div>';
  
  html += '<div class="step">';
  html += '<div class="step-number">Schritt 2: Diagonal addieren</div>';
  html += '<div class="step-content">';
  html += 'Addiere die Zahlen entlang der Diagonalen (von rechts unten nach links oben).<br>';
  html += 'Bei √úbertr√§gen merke dir die Zehnerstelle f√ºr die n√§chste Diagonale.';
  html += '</div></div>';
  
  html += '<div class="step">';
  html += '<div class="step-number">Ergebnis:</div>';
  html += '<div class="step-content">';
  html += `${num1} √ó ${num2} = <span class="highlight-step">${product}</span>`;
  html += '</div></div>';
  
  html += '<div class="tip-box">';
  html += 'üí° Die Gittermethode ist besonders praktisch bei gro√üen Zahlen, weil man sich keine √úbertr√§ge merken muss!';
  html += '</div>';
  
  return html;
}

// Schriftliche Division (klassische deutsche Darstellung)
function generateWrittenDivision(dividend, divisor, quotient) {
  const dividendStr = String(dividend);
  let html = '<div class="written-calc" style="text-align: left; font-size: 1.4rem; line-height: 2;">';
  
  // Kopfzeile: dividend : divisor = quotient
  html += `<div style="border-bottom: 2px solid var(--color-text); padding-bottom: 8px; margin-bottom: 12px;">`;
  html += `<strong>${dividend} : ${divisor} = ${quotient}</strong>`;
  html += `</div>`;
  
  // Berechne die Schritte
  let currentNumber = 0;
  let steps = [];
  
  for (let i = 0; i < dividendStr.length; i++) {
    currentNumber = currentNumber * 10 + parseInt(dividendStr[i]);
    
    if (currentNumber >= divisor) {
      const digit = Math.floor(currentNumber / divisor);
      const product = digit * divisor;
      const remainder = currentNumber - product;
      
      steps.push({
        currentNumber,
        digit,
        product,
        remainder,
        nextDigit: i < dividendStr.length - 1 ? dividendStr[i + 1] : null
      });
      
      currentNumber = remainder;
    }
  }
  
  // Zeige die Rechnung
  for (let i = 0; i < steps.length; i++) {
    const step = steps[i];
    
    html += `<div style="margin: 8px 0;">`;
    if (i === 0) {
      html += `<span style="color: #666;">‚àí</span>${step.product.toString().padStart(String(step.currentNumber).length, ' ')}`;
    } else {
      html += `<span style="visibility: hidden;">‚àí</span>${step.currentNumber}`;
      html += `<br><span style="color: #666;">‚àí</span>${step.product.toString().padStart(String(step.currentNumber).length, ' ')}`;
    }
    html += `<br><span style="border-top: 2px solid var(--color-text); display: inline-block; padding-top: 4px;">`;
    if (step.nextDigit !== null) {
      html += `<span style="visibility: hidden;">${' '.repeat(String(step.remainder).length)}</span>${step.remainder}${step.nextDigit}`;
    } else if (step.remainder === 0) {
      html += `<span style="visibility: hidden;">${' '.repeat(String(step.remainder).length)}</span>  0`;
    } else {
      html += `<span style="visibility: hidden;">${' '.repeat(String(step.remainder).length)}</span>${step.remainder}`;
    }
    html += `</span>`;
    html += `</div>`;
  }
  
  html += '</div>';
  
  // Schrittweise Erkl√§rung
  html += '<div style="margin-top: 24px;">';
  html += '<strong>Schritt f√ºr Schritt:</strong>';
  
  for (let i = 0; i < steps.length; i++) {
    const step = steps[i];
    
    html += '<div class="step">';
    html += `<div class="step-number">Schritt ${i + 1}:</div>`;
    html += '<div class="step-content">';
    
    html += `${step.currentNumber} : ${divisor} = <span class="highlight-step">${step.digit}</span>`;
    html += `<br>Rechnung: ${step.digit} √ó ${divisor} = ${step.product}`;
    html += `<br>Subtraktion: ${step.currentNumber} ‚àí ${step.product} = ${step.remainder}`;
    
    if (step.nextDigit !== null) {
      html += `<br><small style="color: var(--color-primary-dark);">‚Üí Hole die n√§chste Ziffer (${step.nextDigit}) herunter</small>`;
    }
    
    html += '</div></div>';
  }
  
  if (steps[steps.length - 1].remainder > 0) {
    html += '<div class="tip-box">';
    html += `Es bleibt ein Rest von ${steps[steps.length - 1].remainder}`;
    html += '</div>';
  }
  
  html += '</div>';
  
  return html;
}

// Erkl√§rung generieren
function generateExplanation(task) {
  if (!task) return '';
  
  let html = '<div style="line-height: 1.8;">';
  
  if (task.taskType === 'word') {
    html += `<div class="calculation">${task.problem}</div>`;
    html += `<div style="margin: 20px 0; padding: 16px; background: #e6fffa; border-radius: var(--radius-md); border-left: 4px solid #38b2ac;">`;
    html += `<strong>ü§î Was ist gefragt?</strong><br>`;
    html += `Wir m√ºssen herausfinden: Wie lautet die Antwort?`;
    html += `</div>`;
  }
  
  const { num1, num2, answer, op } = task;
  
  if (op === 'add') {
    html += `<div style="margin: 20px 0; padding: 16px; background: #F5F0E8; border-radius: var(--radius-lg); border: 2px solid #E8B86D;">`;
    html += `<div style="font-size: 1.3rem; font-weight: 600; color: #C39759; margin-bottom: 12px;">üìù Die Aufgabe:</div>`;
    html += `<div style="font-size: 2rem; font-weight: 600; text-align: center; color: #2c3e50;">${num1} + ${num2} = ?</div>`;
    html += `</div>`;
    
    if (num1 >= 20 || num2 >= 20) {
      // Schriftlich rechnen f√ºr gro√üe Zahlen
      html += `<div style="margin: 20px 0;"><strong>‚úèÔ∏è Schriftlich rechnen:</strong></div>`;
      html += generateWrittenAddition(num1, num2, answer);
    } else if (num1 <= 10 && num2 <= 10) {
      // === 1. KLASSE: Visuelle Erkl√§rung ===
      html += '<div style="margin: 20px 0;">';
      
      // Schritt 1: Mit Emojis zeigen
      html += '<div style="padding: 20px; background: #E5F2ED; border-radius: var(--radius-lg); margin-bottom: 20px; border: 2px solid #7BA591;">';
      html += '<div style="font-weight: 600; color: #6B9085; margin-bottom: 12px; font-size: 1.2rem;">üëÄ Schau es dir an:</div>';
      
      html += `<div style="margin-bottom: 16px; padding: 12px; background: var(--color-surface); border-radius: var(--radius-md);">`;
      html += `<div style="color: #6B9085; font-weight: 600; margin-bottom: 8px;">Du hast ${num1} √Ñpfel üçé:</div>`;
      html += '<div style="font-size: 2rem; line-height: 1.5;">';
      for (let i = 0; i < num1; i++) {
        html += 'üçé ';
      }
      html += '</div>';
      html += `<div style="margin-top: 8px; color: #7f8c8d; font-size: 0.9rem;">Z√§hle: ${Array.from({length: num1}, (_, i) => i + 1).join(', ')}</div>`;
      html += '</div>';
      
      html += `<div style="text-align: center; font-size: 2rem; color: #E8B86D; font-weight: 600; margin: 12px 0;">‚ûï</div>`;
      
      html += `<div style="margin-bottom: 16px; padding: 12px; background: var(--color-surface); border-radius: var(--radius-md);">`;
      html += `<div style="color: #6B9085; font-weight: 600; margin-bottom: 8px;">Du bekommst ${num2} √Ñpfel dazu üçé:</div>`;
      html += '<div style="font-size: 2rem; line-height: 1.5;">';
      for (let i = 0; i < num2; i++) {
        html += 'üçè ';
      }
      html += '</div>';
      html += '</div>';
      
      html += `<div style="margin-top: 16px; padding: 16px; background: #E8B86D; border-radius: var(--radius-md);">`;
      html += `<div style="color: var(--color-surface); font-weight: 600; margin-bottom: 8px;">‚ú® Zusammen hast du:</div>`;
      html += '<div style="font-size: 2rem; line-height: 1.5;">';
      for (let i = 0; i < num1; i++) {
        html += 'üçé ';
      }
      for (let i = 0; i < num2; i++) {
        html += 'üçè ';
      }
      html += '</div>';
      html += `<div style="margin-top: 12px; padding: 12px; background: var(--color-surface); border-radius: var(--radius-sm); text-align: center;">`;
      html += `<strong style="color: #E8B86D; font-size: 1.3rem;">Z√§hle alle: ${Array.from({length: answer}, (_, i) => i + 1).join(', ')}</strong>`;
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      // Zahlenstrahl
      html += '<div style="padding: 20px; background: #E8F2F4; border-radius: var(--radius-lg); margin-bottom: 20px; border: 2px solid #88B5A5;">';
      html += '<div style="font-weight: 600; color: #6B8A7E; margin-bottom: 12px; font-size: 1.2rem;">üìè Auf dem Zahlenstrahl:</div>';
      html += '<div style="position: relative; padding: 20px 0;">';
      html += '<div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">';
      const start = Math.max(0, num1 - 2);
      const end = answer + 2;
      for (let i = start; i <= end; i++) {
        const isStart = i === num1;
        const isEnd = i === answer;
        html += `<div style="text-align: center; flex: 1;">`;
        html += `<div style="font-size: ${isStart || isEnd ? '1.5rem' : '1.2rem'}; font-weight: ${isStart || isEnd ? '700' : '400'}; color: ${isStart ? 'var(--color-error)' : (isEnd ? '#27ae60' : '#7f8c8d')};">${i}</div>`;
        if (isStart) html += '<div style="font-size: 1.5rem; margin-top: 4px;">üëÜ</div>';
        if (isEnd) html += '<div style="font-size: 1.5rem; margin-top: 4px;">üéØ</div>';
        html += '</div>';
      }
      html += '</div>';
      html += `<div style="background: var(--color-surface); padding: 12px; border-radius: var(--radius-md); margin-top: 16px;">`;
      html += `<strong style="color: #6B8A7E;">So gehts:</strong><br>`;
      html += `1Ô∏è‚É£ Starte bei <strong style="color: var(--color-error);">${num1}</strong> üëÜ<br>`;
      html += `2Ô∏è‚É£ H√ºpfe <strong style="color: #E8B86D;">${num2}-mal nach rechts</strong> ‚û°Ô∏è<br>`;
      html += `3Ô∏è‚É£ Du landest bei <strong style="color: #88B894;">${answer}</strong> üéØ`;
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      // Weiterz√§hlen
      if (num2 <= 5) {
        html += '<div style="padding: 20px; background: #F5F0E8; border-radius: var(--radius-lg); margin-bottom: 20px; border: 2px solid #E8B86D;">';
        html += '<div style="font-weight: 600; color: #C39759; margin-bottom: 12px; font-size: 1.2rem;">üëÜ Z√§hle weiter:</div>';
        let current = num1;
        html += `<div style="font-size: 1.1rem; margin-bottom: 16px; color: #7f8c8d;">Wir starten bei <strong style="color: var(--color-error); font-size: 1.3rem;">${num1}</strong> und z√§hlen <strong style="color: #E8B86D;">${num2}</strong> weiter...</div>`;
        for (let i = 0; i < num2; i++) {
          current++;
          const isLast = i === num2 - 1;
          html += `<div style="padding: 12px; margin: 8px 0; background: ${isLast ? '#27ae60' : 'var(--color-surface)'}; border-radius: var(--radius-md); border: 2px solid ${isLast ? '#27ae60' : '#d68910'}; color: ${isLast ? 'var(--color-surface)' : '#2c3e50'};">`;
          html += `<strong>${i + 1}. Schritt:</strong> ${num1} + ${i + 1} = <strong style="font-size: 1.3rem;">${current}</strong>`;
          if (isLast) html += ' ‚úÖ';
          html += '</div>';
        }
        html += '</div>';
      }
      
      html += '</div>';
    } else {
      // === 2.-4. KLASSE: Kompakte Erkl√§rung ===
      html += '<div style="margin: 20px 0;">';
      html += '<div class="step">';
      html += '<div class="step-number">So rechnest du:</div>';
      html += '<div class="step-content">';
      html += `Beginne mit ${num1} und z√§hle ${num2} dazu:<br>`;
      
      if (num2 <= 5) {
        let current = num1;
        let steps = [];
        for (let i = 0; i < num2; i++) {
          current++;
          steps.push(current);
        }
        html += steps.join(' ‚Üí ');
      } else {
        html += `${num1} + ${num2} = <span class="highlight-step">${answer}</span>`;
      }
      
      html += '</div></div>';
      html += '</div>';
    }
    
    html += `<div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #88B894 0%, #7BA591 100%); border-radius: var(--radius-lg); text-align: center; color: var(--color-surface);">`;
    html += `<div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 8px;">üéâ Die Antwort ist ${answer}!</div>`;
    html += `<div style="font-size: 1rem; opacity: 0.9;">Super gemacht!</div>`;
    html += `</div>`;
    html += `<div style="padding: 16px; background: #E5F2ED; border-radius: var(--radius-md); border-left: 4px solid #1abc9c;">üí° <strong>Tipp:</strong> Du kannst es auch umgekehrt rechnen: ${num2} + ${num1} = ${answer}</div>`;
    
  } else if (op === 'sub') {
    html += `<div style="margin: 20px 0; padding: 16px; background: #F8EDE8; border-radius: var(--radius-lg); border: 3px solid var(--color-error);">`;
    html += `<div style="font-size: 1.3rem; font-weight: 600; color: #B8675D; margin-bottom: 12px;">üìù Die Aufgabe:</div>`;
    html += `<div style="font-size: 2rem; font-weight: 600; text-align: center; color: #2c3e50;">${num1} ‚àí ${num2} = ?</div>`;
    html += `</div>`;
    
    if (num1 >= 20 || num2 >= 20) {
      // Schriftlich rechnen
      html += `<div style="margin: 20px 0;"><strong>‚úèÔ∏è Schriftlich rechnen:</strong></div>`;
      html += generateWrittenSubtraction(num1, num2, answer);
    } else if (num1 <= 10 && num2 <= 10) {
      // === 1. KLASSE: Visuelle Erkl√§rung ===
      html += '<div style="margin: 20px 0;">';
      
      html += '<div style="padding: 20px; background: #F8F5EA; border-radius: var(--radius-lg); margin-bottom: 20px; border: 2px solid #E8B86D;">';
      html += '<div style="font-weight: 600; color: #C39759; margin-bottom: 12px; font-size: 1.2rem;">üëÄ Schau es dir an:</div>';
      
      html += `<div style="margin-bottom: 16px; padding: 12px; background: var(--color-surface); border-radius: var(--radius-md);">`;
      html += `<div style="color: #C39759; font-weight: 600; margin-bottom: 8px;">Du hast ${num1} √Ñpfel üçé:</div>`;
      html += '<div style="font-size: 2rem; line-height: 1.5;">';
      for (let i = 0; i < num1; i++) {
        html += 'üçé ';
      }
      html += '</div>';
      html += `<div style="margin-top: 8px; color: #7f8c8d; font-size: 0.9rem;">Z√§hle: ${Array.from({length: num1}, (_, i) => i + 1).join(', ')}</div>`;
      html += '</div>';
      
      html += `<div style="text-align: center; font-size: 2rem; color: var(--color-error); font-weight: 600; margin: 12px 0;">‚ûñ</div>`;
      
      html += `<div style="margin-bottom: 16px; padding: 12px; background: var(--color-surface); border-radius: var(--radius-md);">`;
      html += `<div style="color: var(--color-error); font-weight: 600; margin-bottom: 8px;">Du isst ${num2} √Ñpfel üçé:</div>`;
      html += '<div style="font-size: 2rem; line-height: 1.5;">';
      for (let i = 0; i < num2; i++) {
        html += '<span style="opacity: 0.3; text-decoration: line-through;">üçé</span> ';
      }
      html += '</div>';
      html += `<div style="margin-top: 8px; color: var(--color-error); font-weight: 600;">Diese ${num2} sind weg!</div>`;
      html += '</div>';
      
      html += `<div style="margin-top: 16px; padding: 16px; background: #88B894; border-radius: var(--radius-md);">`;
      html += `<div style="color: var(--color-surface); font-weight: 600; margin-bottom: 8px;">‚ú® Es bleiben √ºbrig:</div>`;
      html += '<div style="font-size: 2rem; line-height: 1.5;">';
      for (let i = 0; i < answer; i++) {
        html += 'üçé ';
      }
      html += '</div>';
      html += `<div style="margin-top: 12px; padding: 12px; background: var(--color-surface); border-radius: var(--radius-sm); text-align: center;">`;
      html += `<strong style="color: #88B894; font-size: 1.3rem;">Z√§hle: ${answer > 0 ? Array.from({length: answer}, (_, i) => i + 1).join(', ') : '0 (keine mehr √ºbrig)'}</strong>`;
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      html += '<div style="padding: 20px; background: #E8F2F4; border-radius: var(--radius-lg); margin-bottom: 20px; border: 2px solid #88B5A5;">';
      html += '<div style="font-weight: 600; color: #6B8A7E; margin-bottom: 12px; font-size: 1.2rem;">üìè Auf dem Zahlenstrahl:</div>';
      html += '<div style="position: relative; padding: 20px 0;">';
      html += '<div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">';
      const subStart = Math.max(0, answer - 1);
      const subEnd = num1 + 1;
      for (let i = subStart; i <= subEnd; i++) {
        const isStart = i === num1;
        const isEnd = i === answer;
        html += `<div style="text-align: center; flex: 1;">`;
        html += `<div style="font-size: ${isStart || isEnd ? '1.5rem' : '1.2rem'}; font-weight: ${isStart || isEnd ? '700' : '400'}; color: ${isStart ? 'var(--color-error)' : (isEnd ? '#27ae60' : '#7f8c8d')};">${i}</div>`;
        if (isStart) html += '<div style="font-size: 1.5rem; margin-top: 4px;">üëÜ</div>';
        if (isEnd) html += '<div style="font-size: 1.5rem; margin-top: 4px;">üéØ</div>';
        html += '</div>';
      }
      html += '</div>';
      html += `<div style="background: var(--color-surface); padding: 12px; border-radius: var(--radius-md); margin-top: 16px;">`;
      html += `<strong style="color: #6B8A7E;">So gehts:</strong><br>`;
      html += `1Ô∏è‚É£ Starte bei <strong style="color: var(--color-error);">${num1}</strong> üëÜ<br>`;
      html += `2Ô∏è‚É£ H√ºpfe <strong style="color: var(--color-error);">${num2}-mal nach links</strong> ‚¨ÖÔ∏è<br>`;
      html += `3Ô∏è‚É£ Du landest bei <strong style="color: #88B894;">${answer}</strong> üéØ`;
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      if (num2 <= 5) {
        html += '<div style="padding: 20px; background: #F8EDE8; border-radius: var(--radius-lg); margin-bottom: 20px; border: 2px solid var(--color-error);">';
        html += '<div style="font-weight: 600; color: #B8675D; margin-bottom: 12px; font-size: 1.2rem;">üëÜ Z√§hle r√ºckw√§rts:</div>';
        let current = num1;
        html += `<div style="font-size: 1.1rem; margin-bottom: 16px; color: #7f8c8d;">Wir starten bei <strong style="color: var(--color-error); font-size: 1.3rem;">${num1}</strong> und z√§hlen <strong style="color: var(--color-error);">${num2}</strong> zur√ºck...</div>`;
        for (let i = 0; i < num2; i++) {
          current--;
          const isLast = i === num2 - 1;
          html += `<div style="padding: 12px; margin: 8px 0; background: ${isLast ? '#27ae60' : 'var(--color-surface)'}; border-radius: var(--radius-md); border: 2px solid ${isLast ? '#27ae60' : '#var(--color-error)'}; color: ${isLast ? 'var(--color-surface)' : '#2c3e50'};">`;
          html += `<strong>${i + 1}. Schritt:</strong> ${num1} ‚àí ${i + 1} = <strong style="font-size: 1.3rem;">${current}</strong>`;
          if (isLast) html += ' ‚úÖ';
          html += '</div>';
        }
        html += '</div>';
      }
      
      html += '</div>';
    } else {
      // === 2.-4. KLASSE: Kompakte Erkl√§rung ===
      html += '<div style="margin: 20px 0;">';
      html += '<div class="step">';
      html += '<div class="step-number">So rechnest du:</div>';
      html += '<div class="step-content">';
      html += `Beginne mit ${num1} und ziehe ${num2} ab:<br>`;
      html += `${num1} ‚àí ${num2} = <span class="highlight-step">${answer}</span>`;
      html += '</div></div>';
      html += '</div>';
    }
    
    html += `<div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #88B894 0%, #7BA591 100%); border-radius: var(--radius-lg); text-align: center; color: var(--color-surface);">`;
    html += `<div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 8px;">üéâ Die Antwort ist ${answer}!</div>`;
    html += `<div style="font-size: 1rem; opacity: 0.9;">Super gemacht!</div>`;
    html += `</div>`;
    html += `<div style="padding: 16px; background: #E5F2ED; border-radius: var(--radius-md); border-left: 4px solid #1abc9c;">üí° <strong>Tipp:</strong> Zum √úberpr√ºfen: ${answer} + ${num2} = ${num1} ‚úì</div>`;
    
  } else if (op === 'mul') {
    html += `<div style="margin: 20px 0; padding: 16px; background: #EEE9F0; border-radius: var(--radius-lg); border: 2px solid #A77BA5;">`;
    html += `<div style="font-size: 1.3rem; font-weight: 600; color: #8B6B8A; margin-bottom: 12px;">üìù Die Aufgabe:</div>`;
    html += `<div style="font-size: 2rem; font-weight: 600; text-align: center; color: #2c3e50;">${num1} √ó ${num2} = ?</div>`;
    html += `</div>`;
    
    if (num1 >= 20 || num2 >= 11) {
      // Schriftlich rechnen
      html += `<div style="margin: 20px 0;"><strong>‚úèÔ∏è Schriftlich rechnen:</strong></div>`;
      html += generateWrittenMultiplication(num1, num2, answer);
    } else if (num1 <= 10 && num2 <= 5) {
      // === 1. KLASSE: Visuelle Erkl√§rung ===
      html += '<div style="margin: 20px 0;">';
      
      html += '<div style="padding: 20px; background: #E8F2F4; border-radius: var(--radius-lg); margin-bottom: 20px; border: 2px solid #88B5A5;">';
      html += '<div style="font-weight: 600; color: #6B8A7E; margin-bottom: 12px; font-size: 1.2rem;">üëÄ Schau es dir an:</div>';
      html += `<div style="margin-bottom: 16px; color: #7f8c8d; font-size: 1.1rem;">${num1} √ó ${num2} bedeutet: <strong style="color: #A77BA5;">${num2} Gruppen</strong> mit je <strong style="color: #7BA591;">${num1} S√º√üigkeiten</strong></div>`;
      
      for (let group = 0; group < num2; group++) {
        html += `<div style="margin: 12px 0; padding: 12px; background: var(--color-surface); border-radius: var(--radius-md); border: 2px solid #88B5A5;">`;
        html += `<div style="color: #6B8A7E; font-weight: 600; margin-bottom: 8px;">${group + 1}. Gruppe (${num1} St√ºck):</div>`;
        html += '<div style="font-size: 2rem; line-height: 1.5;">';
        for (let i = 0; i < num1; i++) {
          html += 'üç¨ ';
        }
        html += '</div>';
        html += '</div>';
      }
      
      html += `<div style="margin-top: 16px; padding: 16px; background: #A77BA5; border-radius: var(--radius-md);">`;
      html += `<div style="color: var(--color-surface); font-weight: 600; margin-bottom: 8px;">‚ú® Alle zusammen:</div>`;
      html += '<div style="font-size: 2rem; line-height: 1.5;">';
      for (let i = 0; i < answer && i < 50; i++) {
        html += 'üç¨ ';
      }
      if (answer > 50) html += '...';
      html += '</div>';
      html += `<div style="margin-top: 12px; padding: 12px; background: var(--color-surface); border-radius: var(--radius-sm); text-align: center;">`;
      html += `<strong style="color: #A77BA5; font-size: 1.3rem;">Das sind ${answer} S√º√üigkeiten!</strong>`;
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      if (num2 <= 4) {
        html += '<div style="padding: 20px; background: #F8F5EA; border-radius: var(--radius-lg); margin-bottom: 20px; border: 2px solid #E8B86D;">';
        html += '<div style="font-weight: 600; color: #C39759; margin-bottom: 12px; font-size: 1.2rem;">‚ûï Als Plus-Aufgabe:</div>';
        const parts = [];
        for (let i = 0; i < num2; i++) {
          parts.push(num1);
        }
        html += `<div style="padding: 16px; background: var(--color-surface); border-radius: var(--radius-md); margin-bottom: 12px;">`;
        html += `<div style="font-size: 1.2rem; margin-bottom: 12px; color: #7f8c8d;">Mal-Rechnen ist mehrfaches Plus-Rechnen!</div>`;
        html += `<div style="font-size: 1.5rem; font-weight: 600; text-align: center; color: #E8B86D; padding: 12px; background: #F8F5EA; border-radius: var(--radius-sm);">`;
        html += parts.join(' + ') + ` = <strong style="color: #88B894;">${answer}</strong>`;
        html += '</div>';
        html += '</div>';
        let current = 0;
        for (let i = 0; i < num2; i++) {
          current += num1;
          const isLast = i === num2 - 1;
          html += `<div style="padding: 12px; margin: 8px 0; background: ${isLast ? '#27ae60' : 'var(--color-surface)'}; border-radius: var(--radius-md); border: 2px solid ${isLast ? '#27ae60' : '#f39c12'}; color: ${isLast ? 'var(--color-surface)' : '#2c3e50'};">`;
          html += `<strong>${i + 1}. Gruppe:</strong> ${i > 0 ? current - num1 + ' + ' : ''}${num1} = <strong style="font-size: 1.3rem;">${current}</strong>`;
          if (isLast) html += ' ‚úÖ';
          html += '</div>';
        }
        html += '</div>';
      }
      
      html += '<div style="padding: 20px; background: #E5F2ED; border-radius: var(--radius-lg); margin-bottom: 20px; border: 2px solid #7BA591;">';
      html += '<div style="font-weight: 600; color: #6B9085; margin-bottom: 12px; font-size: 1.2rem;">üìö Das Kleine Einmaleins:</div>';
      html += `<div style="padding: 16px; background: var(--color-surface); border-radius: var(--radius-md);">`;
      html += `<div style="margin-bottom: 12px; color: #7f8c8d;">Die <strong style="color: #7BA591;">${num1}er-Reihe</strong>:</div>`;
      html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">';
      for (let i = 1; i <= 10; i++) {
        const result = num1 * i;
        const isAnswer = i === num2;
        html += `<div style="padding: 10px; background: ${isAnswer ? '#1abc9c' : '#f8f9fa'}; border-radius: var(--radius-sm); text-align: center; border: 2px solid ${isAnswer ? '#1abc9c' : '#e0e0e0'}; color: ${isAnswer ? 'var(--color-surface)' : '#2c3e50'}; font-weight: ${isAnswer ? '700' : '600'};">`;
        html += `${num1} √ó ${i} = ${result}`;
        if (isAnswer) html += ' üéØ';
        html += '</div>';
      }
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      html += '</div>';
    } else {
      // === 2.-4. KLASSE: Kompakte Erkl√§rung ===
      html += '<div style="margin: 20px 0;">';
      html += '<div class="step">';
      html += '<div class="step-number">Das Kleine Einmaleins:</div>';
      html += '<div class="step-content">';
      html += `${num1} √ó ${num2} bedeutet: ${num1} wird ${num2}-mal addiert<br>`;
      
      if (num2 <= 4) {
        const parts = [];
        for (let i = 0; i < num2; i++) {
          parts.push(num1);
        }
        html += parts.join(' + ') + ` = <span class="highlight-step">${answer}</span>`;
      } else {
        html += `${num1} √ó ${num2} = <span class="highlight-step">${answer}</span>`;
      }
      
      html += '</div></div>';
      html += '</div>';
    }
    
    html += `<div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #88B894 0%, #7BA591 100%); border-radius: var(--radius-lg); text-align: center; color: var(--color-surface);">`;
    html += `<div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 8px;">üéâ Die Antwort ist ${answer}!</div>`;
    html += `<div style="font-size: 1rem; opacity: 0.9;">Super gemacht!</div>`;
    html += `</div>`;
    html += `<div style="padding: 16px; background: #E5F2ED; border-radius: var(--radius-md); border-left: 4px solid #1abc9c;">üí° <strong>Tipp:</strong> Zum √úberpr√ºfen durch Division: ${answer} √∑ ${num2} = ${num1} ‚úì</div>`;
    
  } else if (op === 'div') {
    html += `<div style="margin: 20px 0; padding: 16px; background: #E8F2F4; border-radius: var(--radius-lg); border: 2px solid #7BA591;">`;
    html += `<div style="font-size: 1.3rem; font-weight: 600; color: #6B8A7E; margin-bottom: 12px;">üìù Die Aufgabe:</div>`;
    html += `<div style="font-size: 2rem; font-weight: 600; text-align: center; color: #2c3e50;">${num1} √∑ ${num2} = ?</div>`;
    html += `</div>`;
    
    if (num1 >= 100 || (num1 >= 20 && num2 >= 3)) {
      // Schriftlich rechnen
      html += `<div style="margin: 20px 0;"><strong>‚úèÔ∏è Schriftlich rechnen:</strong></div>`;
      html += generateWrittenDivision(num1, num2, answer);
    } else if (num1 <= 15 && num2 <= 5) {
      // === 1. KLASSE: Visuelle Erkl√§rung ===
      html += '<div style="margin: 20px 0;">';
      
      html += '<div style="padding: 20px; background: #F8F5EA; border-radius: var(--radius-lg); margin-bottom: 20px; border: 2px solid #E8B86D;">';
      html += '<div style="font-weight: 600; color: #C39759; margin-bottom: 12px; font-size: 1.2rem;">ü§î Was bedeutet das?</div>';
      html += `<div style="padding: 16px; background: var(--color-surface); border-radius: var(--radius-md); margin-bottom: 12px;">`;
      html += `<div style="font-size: 1.1rem; color: #7f8c8d; margin-bottom: 8px;">Wir haben <strong style="color: #E8B86D;">${num1} Kekse</strong> üç™</div>`;
      html += `<div style="font-size: 1.1rem; color: #7f8c8d;">Wir m√∂chten sie <strong style="color: #7BA591;">fair an ${num2} Freunde</strong> verteilen üë•</div>`;
      html += `<div style="font-size: 1.2rem; font-weight: 600; color: #6B8A7E; margin-top: 12px;">‚ùì Wie viele bekommt jeder?</div>`;
      html += '</div>';
      html += '</div>';
      
      html += '<div style="padding: 20px; background: #E5F2ED; border-radius: var(--radius-lg); margin-bottom: 20px; border: 2px solid #7BA591;">';
      html += '<div style="font-weight: 600; color: #6B9085; margin-bottom: 12px; font-size: 1.2rem;">üëÄ Teile die Kekse auf:</div>';
      html += `<div style="margin-bottom: 16px; padding: 12px; background: var(--color-surface); border-radius: var(--radius-md);">`;
      html += `<div style="color: #6B9085; font-weight: 600; margin-bottom: 8px;">So viele Kekse haben wir (${num1}):</div>`;
      html += '<div style="font-size: 2rem; line-height: 1.5;">';
      for (let i = 0; i < num1; i++) {
        html += 'üç™ ';
      }
      html += '</div>';
      html += '</div>';
      html += `<div style="text-align: center; font-size: 1.5rem; color: #7BA591; font-weight: 600; margin: 12px 0;">‚ûó Teile fair auf ${num2} Freunde auf:</div>`;
      for (let friend = 0; friend < num2; friend++) {
        html += `<div style="margin: 12px 0; padding: 12px; background: var(--color-surface); border-radius: var(--radius-md); border: 2px solid #7BA591;">`;
        html += `<div style="color: #6B9085; font-weight: 600; margin-bottom: 8px;">üë§ ${friend + 1}. Freund bekommt:</div>`;
        html += '<div style="font-size: 2rem; line-height: 1.5;">';
        for (let i = 0; i < answer; i++) {
          html += 'üç™ ';
        }
        html += '</div>';
        html += `<div style="margin-top: 8px; color: #7f8c8d; font-size: 0.9rem;">Das sind ${answer} Kekse</div>`;
        html += '</div>';
      }
      html += `<div style="margin-top: 16px; padding: 16px; background: #7BA591; border-radius: var(--radius-md); text-align: center;">`;
      html += `<div style="color: var(--color-surface); font-weight: 600; font-size: 1.2rem;">‚ú® Jeder Freund bekommt ${answer} Kekse!</div>`;
      html += `<div style="color: var(--color-surface); margin-top: 8px; opacity: 0.9;">Alle bekommen gleich viel - das ist fair! ‚úÖ</div>`;
      html += '</div>';
      html += '</div>';
      
      html += '<div style="padding: 20px; background: #EEE9F0; border-radius: var(--radius-lg); margin-bottom: 20px; border: 2px solid #A77BA5;">';
      html += '<div style="font-weight: 600; color: #8B6B8A; margin-bottom: 12px; font-size: 1.2rem;">üîÑ Der Trick: Geteilt ‚Üî Mal</div>';
      html += `<div style="padding: 16px; background: var(--color-surface); border-radius: var(--radius-md); margin-bottom: 12px;">`;
      html += `<div style="font-size: 1.1rem; color: #7f8c8d; margin-bottom: 12px;">Geteilt und Mal sind <strong style="color: #A77BA5;">Gegens√§tze</strong>!</div>`;
      html += '<div style="display: grid; gap: 12px; margin-top: 12px;">';
      html += `<div style="padding: 12px; background: #EEE9F0; border-radius: var(--radius-sm); border-left: 4px solid #8e44ad;">`;
      html += `<strong style="color: #A77BA5;">Mal-Rechnung:</strong> ${num2} Freunde √ó ${answer} Kekse = ${num1} Kekse`;
      html += '</div>';
      html += `<div style="padding: 12px; background: #E8F2F4; border-radius: var(--radius-sm); border-left: 4px solid #3498db;">`;
      html += `<strong style="color: #7BA591;">Geteilt-Rechnung:</strong> ${num1} Kekse √∑ ${num2} Freunde = ${answer} Kekse`;
      html += '</div>';
      html += '</div>';
      html += '</div>';
      html += `<div style="padding: 12px; background: #E5F2ED; border-radius: var(--radius-sm); border-left: 4px solid #1abc9c;">`;
      html += `üí° <strong>Merke dir:</strong> Wenn du das Einmaleins kennst, kannst du auch teilen!`;
      html += '</div>';
      html += '</div>';
      
      html += '<div style="padding: 20px; background: #E5F2ED; border-radius: var(--radius-lg); margin-bottom: 20px; border: 2px solid #7BA591;">';
      html += '<div style="font-weight: 600; color: #6B9085; margin-bottom: 12px; font-size: 1.2rem;">üìö Finde es im Einmaleins:</div>';
      html += `<div style="padding: 16px; background: var(--color-surface); border-radius: var(--radius-md); margin-bottom: 12px;">`;
      html += `<div style="margin-bottom: 12px; color: #7f8c8d;">Suche in der <strong style="color: #7BA591;">${num2}er-Reihe</strong>: Welche Zahl √ó ${num2} = ${num1}?</div>`;
      html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">';
      for (let i = 1; i <= 10; i++) {
        const result = num2 * i;
        const isAnswer = i === answer;
        html += `<div style="padding: 10px; background: ${isAnswer ? '#1abc9c' : '#f8f9fa'}; border-radius: var(--radius-sm); text-align: center; border: 2px solid ${isAnswer ? '#1abc9c' : '#e0e0e0'}; color: ${isAnswer ? 'var(--color-surface)' : '#2c3e50'}; font-weight: ${isAnswer ? '700' : '600'};">`;
        html += `${num2} √ó ${i} = ${result}`;
        if (isAnswer) html += ' üéØ';
        html += '</div>';
      }
      html += '</div>';
      if (answer <= 10) {
        html += `<div style="margin-top: 12px; padding: 12px; background: #7BA591; color: var(--color-surface); border-radius: var(--radius-sm); text-align: center; font-weight: 600;">`;
        html += `Gefunden! ${num2} √ó ${answer} = ${num1} ‚û°Ô∏è Also ist ${num1} √∑ ${num2} = ${answer}`;
        html += '</div>';
      }
      html += '</div>';
      html += '</div>';
      
      html += '</div>';
    } else {
      // === 2.-4. KLASSE: Kompakte Erkl√§rung ===
      html += '<div style="margin: 20px 0;">';
      html += '<div class="step">';
      html += '<div class="step-number">Was bedeutet das?</div>';
      html += '<div class="step-content">';
      html += `Wir teilen ${num1} in ${num2} gleiche Teile.<br>`;
      html += `Oder: Wie oft passt ${num2} in ${num1}?`;
      html += '</div></div>';
      html += '</div>';
      html += '<div style="margin: 20px 0;">';
      html += '<div class="step">';
      html += '<div class="step-number">So rechnest du:</div>';
      html += '<div class="step-content">';
      html += `${num2} √ó ${answer} = ${num1}<br>`;
      html += `Also: ${num1} √∑ ${num2} = <span class="highlight-step">${answer}</span>`;
      html += '</div></div>';
      html += '</div>';
    }
    
    html += `<div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #88B894 0%, #7BA591 100%); border-radius: var(--radius-lg); text-align: center; color: var(--color-surface);">`;
    html += `<div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 8px;">üéâ Die Antwort ist ${answer}!</div>`;
    html += `<div style="font-size: 1rem; opacity: 0.9;">Super gemacht!</div>`;
    html += `</div>`;
    html += `<div style="padding: 16px; background: #E5F2ED; border-radius: var(--radius-md); border-left: 4px solid #1abc9c;">üí° <strong>Tipp:</strong> Zum √úberpr√ºfen: ${answer} √ó ${num2} = ${num1} ‚úì</div>`;
  }
  
  html += '</div>';
  
  return html;
}

// Speichern & Laden
function saveState() {
  try {
    localStorage.setItem('mathApp', JSON.stringify({
      score: state.score,
      total: state.total,
      maxStreak: state.maxStreak,
      settings: state.settings
    }));
  } catch (e) {
    // Falls localStorage nicht verf√ºgbar ist, einfach leise ignorieren
  }
}

function loadState() {
  try {
    const saved = JSON.parse(localStorage.getItem('mathApp'));
    if (saved) {
      state.score = saved.score || 0;
      state.total = saved.total || 0;
      state.maxStreak = saved.maxStreak || 0;
      state.settings = {...state.settings, ...saved.settings};
    }
  } catch (e) {}
}

// Sprachausgabe
function speak(text) {
  if (!state.settings.sound || !synth) return;
  synth.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'de-DE';
  utterance.rate = 0.85;
  if (state.voice) utterance.voice = state.voice;
  synth.speak(utterance);
}

if (synth) {
  synth.onvoiceschanged = () => {
    state.voice = synth.getVoices().find(v => v.lang.startsWith('de')) || null;
  };
}

// Timer
function startTimer() {
  if (!state.settings.timer) return;
  stopTimer();
  state.timerValue = 30;
  $('timer').style.display = 'block';
  $('time').textContent = state.timerValue;
  $('timer').classList.remove('warning');
  
  state.timerInterval = setInterval(() => {
    state.timerValue--;
    $('time').textContent = state.timerValue;
    
    if (state.timerValue <= 10) {
      $('timer').classList.add('warning');
    }
    
    if (state.timerValue <= 0) {
      stopTimer();
      if (!state.answered) {
        answerQuestion(-1);
        $('msg').textContent = '‚è±Ô∏è Zeit abgelaufen!';
      }
    }
  }, 1000);
}

function stopTimer() {
  if (state.timerInterval) {
    clearInterval(state.timerInterval);
    state.timerInterval = null;
  }
  // Immer ausblenden, egal ob Timer in den Settings an/aus ist
  if ($('timer')) {
    $('timer').style.display = 'none';
  }
}

// UI Updates
function bumpStat(id) {
  const el = $(id);
  if (!el) return;
  el.classList.remove('bump');
  // Reflow-Trick, damit die Animation erneut abgespielt wird
  void el.offsetWidth;
  el.classList.add('bump');
}

function updateStats() {
  $('score').textContent = state.score;
  $('total').textContent = state.total;
  $('streak').textContent = state.streak;
  bumpStat('score');
  bumpStat('total');
  bumpStat('streak');
}

function updateHistory() {
  const html = state.history.slice(-5).reverse().map(item => 
    `<div class="history-item ${item.correct ? 'ok' : 'no'}">${item.problem}</div>`
  ).join('');
  $('history').innerHTML = html || '<div style="text-align:center;opacity:0.6;padding:10px;">Noch keine Aufgaben</div>';
}

function showHistoryModal() {
  const accuracy = state.total > 0 ? Math.round((state.score / state.total) * 100) : 0;
  const html = `
    <div class="settings-panel">
      <div class="setting-row">
        <div class="setting-label">Gesamt beantwortet</div>
        <div style="font-weight: 600; font-size: 1.2rem;">${state.total}</div>
      </div>
      <div class="setting-row">
        <div class="setting-label">Richtig</div>
        <div style="font-weight: 600; font-size: 1.2rem;">${state.score}</div>
      </div>
      <div class="setting-row">
        <div class="setting-label">Genauigkeit</div>
        <div style="font-weight: 600; font-size: 1.2rem;">${accuracy}%</div>
      </div>
      <div class="setting-row">
        <div class="setting-label">L√§ngste Serie</div>
        <div style="font-weight: 600; font-size: 1.2rem;">${state.maxStreak}</div>
      </div>
      <div class="setting-row">
        <div class="setting-label">Aktuelle Serie</div>
        <div style="font-weight: 600; font-size: 1.2rem;">${state.streak}</div>
      </div>
    </div>
    <div style="margin-top: 20px;">
      <strong style="margin-bottom: 12px; display: block;">Letzte Aufgaben:</strong>
      <div class="history">
        ${state.history.slice(-8).reverse().map(item => 
          `<div class="history-item ${item.correct ? 'ok' : 'no'}">${item.problem}</div>`
        ).join('') || '<div style="text-align:center;opacity:0.6;">Noch keine Aufgaben</div>'}
      </div>
    </div>
  `;
  $('mbody-history').innerHTML = html;
  $('ov-history').classList.add('show');
}

// Aufgabe starten
function startNewTask() {
  state.currentTask = createTask(state.grade);
  state.answered = false;
  
  $('task').textContent = state.currentTask.problem;
  $('msg').className = 'msg';
  $('msg').textContent = 'W√§hle die richtige Antwort';
  $('help').disabled = false;
  
  $('ans').innerHTML = '';
  state.currentTask.options.forEach((option, index) => {
    const btn = document.createElement('button');
    btn.textContent = option;
    btn.onclick = () => answerQuestion(index);
    $('ans').appendChild(btn);
  });
  
  let spokenText;
  if (state.currentTask.taskType === 'word') {
    spokenText = state.currentTask.problem;
  } else {
    spokenText = state.currentTask.problem
      .replace(/\+/g, ' plus ')
      .replace(/‚àí/g, ' minus ')
      .replace(/√ó/g, ' mal ')
      .replace(/√∑/g, ' geteilt durch ')
      .replace(/\?/g, '')
      .replace(/=/g, ' gleich ');
  }
  speak(spokenText);
  
  startTimer();
}

// Antwort pr√ºfen
function answerQuestion(selectedIndex) {
  if (state.answered) return;
  
  state.answered = true;
  stopTimer();
  
  const buttons = $('ans').querySelectorAll('button');
  const correctIndex = state.currentTask.correctIndex;
  
  buttons[correctIndex].classList.add('ok');
  
  const isCorrect = selectedIndex === correctIndex;
  state.total++;
  
  if (isCorrect) {
    state.score++;
    state.streak++;
    if (state.streak > state.maxStreak) {
      state.maxStreak = state.streak;
    }
    $('msg').className = 'msg ok';
    $('msg').textContent = '‚úÖ Richtig! Super gemacht!';
    speak('Richtig! Super gemacht!');
  } else {
    state.streak = 0;
    if (selectedIndex >= 0) {
      buttons[selectedIndex].classList.add('no');
    }
    $('msg').className = 'msg no';
    $('msg').textContent = `Leider falsch. Die richtige Antwort ist: ${state.currentTask.options[correctIndex]}`;
    speak('Leider falsch. Versuch es beim n√§chsten Mal noch einmal.');
  }
  
  state.history.push({
    problem: state.currentTask.problem.replace('?', state.currentTask.options[correctIndex]),
    correct: isCorrect
  });
  
  updateStats();
  updateHistory();
  saveState();
}

// Event Listeners
$('grades').onclick = e => {
  const btn = e.target.closest('button[data-g]');
  if (!btn) return;
  
  state.grade = +btn.dataset.g;
  $('grades').querySelectorAll('button').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
};

$('start').onclick = startNewTask;

$('help').onclick = () => {
  if (!state.currentTask) return;
  $('mbody-help').innerHTML = generateExplanation(state.currentTask);
  $('ov-help').classList.add('show');
};

$('history-btn').onclick = showHistoryModal;
$('history-btn-2').onclick = showHistoryModal;

$('snd').onclick = () => {
  state.settings.sound = !state.settings.sound;
  $('snd').textContent = state.settings.sound ? 'üîä' : 'üîá';
  $('toggle-sound').classList.toggle('on', state.settings.sound);
  saveState();
};

$('settings').onclick = () => {
  $('toggle-timer').classList.toggle('on', state.settings.timer);
  $('toggle-sound').classList.toggle('on', state.settings.sound);
  $('toggle-keys').classList.toggle('on', state.settings.keyboard);
  $('ov-settings').classList.add('show');
};

// Modal controls
['help', 'settings', 'history'].forEach(name => {
  $(`cls-${name}`).onclick = () => $(`ov-${name}`).classList.remove('show');
  $(`mok-${name}`).onclick = () => $(`ov-${name}`).classList.remove('show');
  $(`ov-${name}`).onclick = e => {
    if (e.target === $(`ov-${name}`)) {
      $(`ov-${name}`).classList.remove('show');
    }
  };
});

// Toggle controls
$('toggle-timer').onclick = () => {
  state.settings.timer = !state.settings.timer;
  $('toggle-timer').classList.toggle('on', state.settings.timer);
  if (!state.settings.timer) stopTimer();
  saveState();
};

$('toggle-sound').onclick = () => {
  state.settings.sound = !state.settings.sound;
  $('toggle-sound').classList.toggle('on', state.settings.sound);
  $('snd').textContent = state.settings.sound ? 'üîä' : 'üîá';
  saveState();
};

$('toggle-keys').onclick = () => {
  state.settings.keyboard = !state.settings.keyboard;
  $('toggle-keys').classList.toggle('on', state.settings.keyboard);
  saveState();
};

// Keyboard shortcuts
document.onkeydown = e => {
  if (!state.settings.keyboard) return;
  
  if (e.key === 'Escape') {
    ['help', 'settings', 'history'].forEach(name => {
      $(`ov-${name}`).classList.remove('show');
    });
    return;
  }
  
  if ($('ov-help').classList.contains('show') || 
      $('ov-settings').classList.contains('show') ||
      $('ov-history').classList.contains('show')) {
    return;
  }
  
  if (e.key === 'Enter') {
    $('start').click();
  } else if (e.key.toLowerCase() === 'e' && state.currentTask) {
    $('help').click();
  } else if ('1234'.includes(e.key)) {
    const btn = $('ans').querySelectorAll('button')[+e.key - 1];
    if (btn) btn.click();
  }
};

// Initialize
loadState();
updateStats();
updateHistory();
</script>
</body>
</html>
