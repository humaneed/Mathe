<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1a5c3a">
  <title>Mathe √ºben</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    /* Design-Award inspiriertes Farbschema */
    :root {
      --color-primary: #7BA591;
      --color-primary-dark: #5D8A75;
      --color-primary-light: #A8C9B8;
      --color-accent: #E8B86D;
      --color-accent-dark: #D4A055;
      --color-success: #88B894;
      --color-error: #D4816F;
      --color-text: #3D4F42;
      --color-text-light: #6B7C70;
      --color-bg: #F9F7F4;
      --color-surface: #FFFFFF;
      --color-border: #E3DED7;
      --shadow-sm: 0 2px 8px rgba(61, 79, 66, 0.08);
      --shadow-md: 0 4px 16px rgba(61, 79, 66, 0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --font-display: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Roboto', sans-serif;
      --font-body: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', 'Roboto', sans-serif;
    }
    
    html {
      height: 100%;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body { 
      font-family: var(--font-body);
      background: var(--color-bg);
      height: 100vh;
      height: 100dvh;
      overflow: hidden;
      padding: 0;
      color: var(--color-text);
      position: fixed;
      width: 100%;
      -webkit-overflow-scrolling: touch;
      font-weight: 400;
      letter-spacing: 0.01em;
      line-height: 1.6;
    }
    
    .app-wrapper {
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .container { 
      max-width: 900px; 
      margin: 0 auto;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      -webkit-overflow-scrolling: touch;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      background: var(--color-surface);
      padding: 16px;
      padding-top: calc(16px + env(safe-area-inset-top));
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 100;
      flex-shrink: 0;
      border-bottom: 1px solid var(--color-border);
    }
    
    .logo { 
      font-size: 1.35rem; 
      font-weight: 600;
      color: var(--color-primary-dark);
      white-space: nowrap;
      letter-spacing: -0.02em;
      font-family: var(--font-display);
    }
    
    .stats {
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .stats::-webkit-scrollbar {
      display: none;
    }
    
    .stat-box {
      background: var(--color-primary-light);
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--color-primary-dark);
      border: 1px solid var(--color-primary);
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .stat-value { 
      font-weight: 600; 
      margin-left: 4px; 
      color: var(--color-primary-dark);
      font-feature-settings: 'tnum';
      font-variant-numeric: tabular-nums;
    }
    
    .card { 
      background: var(--color-surface);
      border-radius: var(--radius-lg); 
      padding: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--color-border);
      margin-bottom: 16px;
    }
    
    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }
    
    .grades { display: flex; gap: 8px; flex-wrap: wrap; }
    
    .grades button { 
      padding: 10px 16px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--color-text);
      transition: var(--transition);
    }
    
    .grades button:hover {
      background: var(--color-bg);
      border-color: var(--color-primary);
    }
    
    .grades button.on { 
      background: var(--color-primary);
      border-color: var(--color-primary-dark);
      color: var(--color-surface);
    }
    
    .icon-btn {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-md);
      border: 2px solid var(--color-border);
      background: var(--color-surface);
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--color-text);
      transition: var(--transition);
    }
    
    .icon-btn:hover {
      background: var(--color-bg);
      transform: scale(1.05);
    }
    
    .task-area {
      background: var(--color-bg);
      border-radius: var(--radius-md);
      padding: 32px;
      text-align: center;
      margin-bottom: 20px;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--color-border);
    }
    
    .task-text { 
      font-size: clamp(1.5rem, 8vw, 2.5rem);
      font-weight: 600;
      color: var(--color-text);
      text-align: center;
      margin: 24px 0;
      line-height: 1.4;
      font-family: var(--font-display);
      letter-spacing: -0.02em;
    }
    
    .task-context {
      font-size: 1rem;
      color: var(--color-text-light);
      margin-bottom: 16px;
      font-style: italic;
    }
    
    .answers { 
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .answers button { 
      padding: 24px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      background: var(--color-surface);
      font-size: 1.3rem;
      font-weight: 600;
      cursor: pointer;
      color: var(--color-text);
      transition: var(--transition);
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .answers button:hover {
      background: var(--color-bg);
      border-color: var(--color-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .answers button.ok { 
      background: var(--color-success);
      border-color: var(--color-success);
      color: var(--color-surface);
    }
    
    .answers button.no { 
      background: var(--color-error);
      border-color: var(--color-error);
      color: var(--color-surface);
    }
    
    .msg { 
      text-align: center;
      padding: 16px;
      border-radius: var(--radius-md);
      margin-bottom: 20px;
      font-weight: 600;
      font-size: 1.1rem;
      background: var(--color-bg);
      border: 2px solid var(--color-border);
      color: var(--color-text);
    }
    
    .msg.ok { 
      background: var(--color-success);
      border-color: var(--color-success);
      color: #22543d;
    }
    
    .msg.no { 
      background: #fed7d7;
      border-color: #fc8181;
      color: #742a2a;
    }
    
    .history {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
      max-height: 250px;
      overflow-y: auto;
    }
    
    .history-item {
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      font-size: 0.95rem;
      border-left: 3px solid;
    }
    
    .history-item.ok {
      background: #f0fdf4;
      border-color: var(--color-success);
      color: #15803d;
    }
    
    .history-item.no {
      background: #fef2f2;
      border-color: var(--color-error);
      color: #991b1b;
    }
    
    .btns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .btns button {
      padding: 16px;
      border-radius: var(--radius-md);
      border: 2px solid var(--color-border);
      background: var(--color-surface);
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: var(--transition);
      color: var(--color-text);
    }
    
    .btns button:hover {
      background: var(--color-bg);
      border-color: var(--color-primary);
      transform: translateY(-2px);
    }
    
    .btns button.main {
      grid-column: 1 / -1;
      background: var(--color-primary);
      border-color: var(--color-primary-dark);
      color: var(--color-surface);
      font-size: 1.1rem;
    }
    
    .btns button.main:hover {
      background: var(--color-primary-dark);
      border-color: var(--color-primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .btns button.help {
      background: var(--color-accent);
      border-color: var(--color-accent-dark);
      color: var(--color-surface);
    }
    
    .btns button.help:hover {
      background: var(--color-accent-dark);
      border-color: var(--color-accent-dark);
    }
    
    .btns button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      max-height: 90dvh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--color-bg);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }
    
    .modal-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--color-text);
      font-family: var(--font-display);
    }
    
    .modal-close {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      font-size: 1.8rem;
      cursor: pointer;
      color: var(--color-text);
      border-radius: 50%;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    
    .modal-close:hover {
      background: var(--color-border);
    }
    
    .modal-body {
      padding: 24px;
      color: var(--color-text);
    }
    
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--color-border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    .modal-footer button {
      padding: 12px 24px;
      border-radius: var(--radius-md);
      border: none;
      background: var(--color-primary);
      color: var(--color-surface);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .modal-footer button:hover {
      background: var(--color-primary-dark);
    }
    
    .settings-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: var(--color-bg);
      border-radius: var(--radius-md);
    }
    
    .setting-label {
      font-weight: 600;
      color: var(--color-text);
    }
    
    .toggle {
      width: 50px;
      height: 28px;
      background: var(--color-border);
      border-radius: 14px;
      position: relative;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .toggle::after {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      background: var(--color-surface);
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: var(--transition);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .toggle.on {
      background: var(--color-primary);
    }
    
    .toggle.on::after {
      transform: translateX(22px);
    }
    
    .timer {
      position: absolute;
      top: 12px;
      right: 12px;
      background: var(--color-surface);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 8px 16px;
      font-weight: 600;
      font-size: 1rem;
      color: var(--color-text);
      display: none;
      z-index: 10;
      box-shadow: var(--shadow-sm);
    }
    
    .timer.warning {
      background: #fee;
      border-color: var(--color-error);
      color: var(--color-error);
      animation: pulse 0.5s ease-in-out infinite alternate;
    }
    
    @keyframes pulse {
      from { transform: scale(1); }
      to { transform: scale(1.05); }
    }
    
    .step {
      margin: 16px 0;
      padding: 16px;
      background: var(--color-bg);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--color-primary);
    }
    
    .step-number {
      font-weight: 600;
      color: var(--color-primary-dark);
      margin-bottom: 8px;
      font-size: 1.1rem;
    }
    
    .step-content {
      color: var(--color-text);
      line-height: 1.6;
    }
    
    .difficulty-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 16px;
    }
    
    .difficulty-easy {
      background: #d1fae5;
      color: #065f46;
    }
    
    .difficulty-medium {
      background: #fef3c7;
      color: #92400e;
    }
    
    .difficulty-hard {
      background: #fee2e2;
      color: #991b1b;
    }
    
    @media (max-width: 640px) {
      .container {
        padding: 8px;
      }
      
      .card {
        padding: 16px;
        margin-bottom: 8px;
      }
      
      .logo {
        font-size: 1.1rem;
      }
      
      .stat-box {
        font-size: 0.8rem;
        padding: 4px 10px;
      }
      
      .task-text { 
        font-size: clamp(1.3rem, 8vw, 2rem);
        margin: 16px 0;
      }
      
      .answers { 
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .answers button {
        min-height: 60px;
        font-size: 1.1rem;
        padding: 16px;
      }
      
      .btns { 
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .controls { 
        flex-direction: column; 
        align-items: stretch;
        gap: 12px;
      }
      
      .grades { 
        justify-content: stretch;
        gap: 6px;
      }
      
      .grades button {
        flex: 1;
        font-size: 0.85rem;
        padding: 10px 8px;
      }
      
      .modal-body {
        padding: 16px;
      }
    }
    
    @media (max-width: 380px) {
      .logo {
        font-size: 1rem;
      }
      
      .stat-box {
        font-size: 0.75rem;
        padding: 4px 8px;
      }
      
      .grades button {
        font-size: 0.8rem;
        padding: 8px 6px;
      }
      
      .icon-btn {
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <div class="header">
      <div class="logo">üßÆ Mathe √ºben</div>
      <div class="stats">
        <div class="stat-box">Punkte: <span class="stat-value" id="score">0</span></div>
        <div class="stat-box">Gesamt: <span class="stat-value" id="total">0</span></div>
        <div class="stat-box">üî• Serie: <span class="stat-value" id="streak">0</span></div>
      </div>
    </div>
    
    <div class="container">
    <div class="card">
      <div class="controls">
        <div class="grades" id="grades">
          <button data-g="1" class="on">1. Klasse</button>
          <button data-g="2">2. Klasse</button>
          <button data-g="3">3. Klasse</button>
          <button data-g="4">4. Klasse</button>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="icon-btn" id="snd">üîä</button>
          <button class="icon-btn" id="history-btn">üìä</button>
          <button class="icon-btn" id="settings">‚öôÔ∏è</button>
        </div>
      </div>
      
      <div style="position: relative;">
        <div class="timer" id="timer">‚è±Ô∏è <span id="time">30</span>s</div>
        <div class="task-area">
          <div class="task-text" id="task">Klicke auf "Neue Aufgabe"</div>
        </div>
      </div>
      
      <div class="answers" id="ans"></div>
      
      <div class="msg" id="msg">W√§hle eine Klassenstufe und klicke auf "Neue Aufgabe"</div>
      
      <div class="history" id="history"></div>
      
      <div class="btns">
        <button class="help" id="help" disabled>üí° Erkl√§rung</button>
        <button id="history-btn-2">üìä Verlauf</button>
        <button class="main" id="start">Neue Aufgabe</button>
      </div>
    </div>
  </div>
  </div>
  </div>

<div class="modal" id="ov-help">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">üí° Erkl√§rung</div>
      <button class="modal-close" id="cls-help">√ó</button>
    </div>
    <div class="modal-body" id="mbody-help"></div>
    <div class="modal-footer">
      <button id="mok-help">Verstanden</button>
    </div>
  </div>
</div>

<div class="modal" id="ov-settings">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">‚öôÔ∏è Einstellungen</div>
      <button class="modal-close" id="cls-settings">√ó</button>
    </div>
    <div class="modal-body">
      <div class="settings-panel">
        <div class="setting-row">
          <div class="setting-label">‚è±Ô∏è Timer (30 Sekunden)</div>
          <div class="toggle" id="toggle-timer"></div>
        </div>
        <div class="setting-row">
          <div class="setting-label">üîä Sprachausgabe</div>
          <div class="toggle on" id="toggle-sound"></div>
        </div>
        <div class="setting-row">
          <div class="setting-label">‚å®Ô∏è Tastatur-Shortcuts</div>
          <div class="toggle on" id="toggle-keys"></div>
        </div>
      </div>
      <div style="margin-top: 20px; padding: 12px; background: var(--color-bg); border-radius: var(--radius-sm); font-size: 0.9rem;">
        <strong>Tastatur-Shortcuts:</strong><br>
        <kbd style="padding: 2px 6px; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 4px; font-family: monospace;">Enter</kbd> = Neue Aufgabe<br>
        <kbd style="padding: 2px 6px; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 4px; font-family: monospace;">1-4</kbd> = Antwort ausw√§hlen<br>
        <kbd style="padding: 2px 6px; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 4px; font-family: monospace;">E</kbd> = Erkl√§rung<br>
        <kbd style="padding: 2px 6px; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 4px; font-family: monospace;">Esc</kbd> = Modal schlie√üen
      </div>
    </div>
    <div class="modal-footer">
      <button id="mok-settings">OK</button>
    </div>
  </div>
</div>

<div class="modal" id="ov-history">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">üìä Statistiken</div>
      <button class="modal-close" id="cls-history">√ó</button>
    </div>
    <div class="modal-body" id="mbody-history"></div>
    <div class="modal-footer">
      <button id="mok-history">OK</button>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);

const state = {
  grade: 1,
  score: 0,
  total: 0,
  streak: 0,
  maxStreak: 0,
  currentTask: null,
  answered: false,
  history: [],
  settings: {
    timer: false,
    sound: true,
    keyboard: true
  },
  timerInterval: null,
  timerValue: 30,
  voice: null
};

// ==================== HILFSFUNKTIONEN ====================

function rnd(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function pick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function shuffle(arr) {
  const copy = [...arr];
  for (let i = copy.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy;
}

// ==================== KLASSE 1: Zahlenraum bis 20 ====================
// Curriculum: Zahlen bis 20, Addition/Subtraktion, Zehner√ºbergang

// 1. Addition im Zahlenraum bis 20 (mit Zehner√ºbergang)
function createAdditionTask1() {
  const useCarry = Math.random() < 0.5;
  let a, b, sum;
  
  if (useCarry) {
    // Mit Zehner√ºbergang (z.B. 8+5=13)
    a = rnd(7, 9);
    b = rnd(3, 9);
    sum = a + b;
    if (sum > 20) sum = a + rnd(2, 5);
  } else {
    // Ohne Zehner√ºbergang (z.B. 7+2=9)
    a = rnd(1, 9);
    b = rnd(1, 9 - a);
  }
  
  sum = a + b;
  const correct = sum;
  const wrong1 = sum + 1;
  const wrong2 = sum - 1;
  const wrong3 = a + b + rnd(2, 4);
  
  return {
    problem: `${a} + ${b} = ?`,
    context: "Addition bis 20",
    taskType: 'addition',
    difficulty: useCarry ? 'medium' : 'easy',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${a} + ${b} = ${sum}. ${useCarry ? `Tipp: Erst bis zur 10 rechnen: ${a} + ${10-a} = 10, dann noch ${b-(10-a)} dazu = ${sum}` : ''}`
  };
}

// 2. Subtraktion im Zahlenraum bis 20
function createSubtractionTask1() {
  const a = rnd(6, 20);
  const b = rnd(2, a - 1);
  const diff = a - b;
  
  const correct = diff;
  const wrong1 = diff + 1;
  const wrong2 = diff - 1;
  const wrong3 = a + b;
  
  return {
    problem: `${a} ‚àí ${b} = ?`,
    context: "Subtraktion bis 20",
    taskType: 'subtraction',
    difficulty: a > 10 ? 'medium' : 'easy',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${a} ‚àí ${b} = ${diff}. Zur Probe: ${diff} + ${b} = ${a} ‚úì`
  };
}

// 3. Verdoppeln und Halbieren
function createDoublingTask1() {
  const type = Math.random() < 0.5 ? 'double' : 'half';
  
  if (type === 'double') {
    const num = rnd(3, 10);
    const doubled = num * 2;
    const correct = doubled;
    
    return {
      problem: `Das Doppelte von ${num}`,
      context: "Verdoppeln",
      taskType: 'doubling',
      difficulty: 'easy',
      correctAnswer: correct,
      options: shuffle([correct, doubled + 1, doubled - 2, doubled + 2]),
      explanation: `Das Doppelte von ${num} ist ${num} + ${num} = ${doubled}`
    };
  } else {
    const evenNum = rnd(2, 10) * 2;
    const half = evenNum / 2;
    const correct = half;
    
    return {
      problem: `Die H√§lfte von ${evenNum}`,
      context: "Halbieren",
      taskType: 'halving',
      difficulty: 'easy',
      correctAnswer: correct,
      options: shuffle([correct, half + 1, half - 1, half + 2]),
      explanation: `Die H√§lfte von ${evenNum} ist ${half}. Das ist das Gleiche wie ${evenNum} √∑ 2 = ${half}`
    };
  }
}

// 4. Zahlenzerlegung (Zehner und Einer)
function createDecompositionTask1() {
  const num = rnd(11, 19);
  const ones = num - 10;
  
  const correct = ones;
  const wrong1 = ones + 1;
  const wrong2 = ones - 1;
  const wrong3 = 10 - ones;
  
  return {
    problem: `${num} = 10 + ?`,
    context: "Zahlen zerlegen",
    taskType: 'decomposition',
    difficulty: 'easy',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${num} = 10 + ${ones}. Die ${num} besteht aus 1 Zehner (10) und ${ones} Einern.`
  };
}

// 5. Vergleichen: Gr√∂√üer, kleiner, gleich
function createComparisonTask1() {
  const a = rnd(5, 19);
  const b = rnd(5, 19);
  
  while (Math.abs(a - b) < 2) {
    b = rnd(5, 19);
  }
  
  const larger = Math.max(a, b);
  const smaller = Math.min(a, b);
  
  const questions = [
    { q: 'Welche Zahl ist gr√∂√üer?', correct: larger },
    { q: 'Welche Zahl ist kleiner?', correct: smaller }
  ];
  
  const question = pick(questions);
  const correct = question.correct;
  
  return {
    problem: `${a}  und  ${b}\n\n${question.q}`,
    context: "Zahlen vergleichen",
    taskType: 'comparison',
    difficulty: 'easy',
    correctAnswer: correct,
    options: shuffle([correct, correct === larger ? smaller : larger, correct + 1, correct - 1]),
    explanation: `${larger} ist gr√∂√üer als ${smaller}. ${larger} > ${smaller}`
  };
}

// ==================== KLASSE 2: Zahlenraum bis 100 ====================
// Curriculum: Zahlen bis 100, Addition/Subtraktion, Einmaleins (2,5,10 dann 3,4,6,7,8,9), Geld, Uhrzeit

// 6. Addition bis 100
function createAdditionTask2() {
  const a = rnd(15, 85);
  const b = rnd(5, 40);
  const sum = a + b;
  
  if (sum > 100) {
    return createAdditionTask2();
  }
  
  const correct = sum;
  const wrong1 = sum + 10;
  const wrong2 = sum - 10;
  const wrong3 = a - b;
  
  return {
    problem: `${a} + ${b} = ?`,
    context: "Addition bis 100",
    taskType: 'addition',
    difficulty: 'medium',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${a} + ${b} = ${sum}. Tipp: Rechne in Schritten, z.B. erst +${Math.floor(b/10)*10}, dann +${b%10}`
  };
}

// 7. Subtraktion bis 100
function createSubtractionTask2() {
  const a = rnd(25, 99);
  const b = rnd(5, a - 5);
  const diff = a - b;
  
  const correct = diff;
  const wrong1 = diff + 10;
  const wrong2 = diff - 10;
  const wrong3 = a + b;
  
  return {
    problem: `${a} ‚àí ${b} = ?`,
    context: "Subtraktion bis 100",
    taskType: 'subtraction',
    difficulty: 'medium',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${a} ‚àí ${b} = ${diff}. Zur Probe: ${diff} + ${b} = ${a} ‚úì`
  };
}

// 8. Einmaleins (2er, 3er, 4er, 5er, 10er Reihe haupts√§chlich)
function createMultiplicationTask2() {
  const multiplicands = [2, 2, 3, 4, 5, 5, 10, 10]; // 2,5,10 h√§ufiger
  const factor1 = pick(multiplicands);
  const factor2 = rnd(2, 10);
  const product = factor1 * factor2;
  
  const correct = product;
  const wrong1 = product + factor1;
  const wrong2 = product - factor1;
  const wrong3 = factor1 + factor2;
  
  return {
    problem: `${factor1} √ó ${factor2} = ?`,
    context: `Das kleine Einmaleins: ${factor1}er-Reihe`,
    taskType: 'multiplication',
    difficulty: factor1 <= 5 ? 'easy' : 'medium',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${factor1} √ó ${factor2} = ${product}. Das ist: ${factor1} + ${factor1} + ... (${factor2} mal)`
  };
}

// 9. Division (Einmaleins-Umkehrung)
function createDivisionTask2() {
  const divisors = [2, 5, 10, 3, 4]; // Einfache Divisoren
  const divisor = pick(divisors);
  const quotient = rnd(2, 10);
  const dividend = divisor * quotient;
  
  const correct = quotient;
  const wrong1 = quotient + 1;
  const wrong2 = quotient - 1;
  const wrong3 = dividend - divisor;
  
  return {
    problem: `${dividend} √∑ ${divisor} = ?`,
    context: "Geteilt (ohne Rest)",
    taskType: 'division',
    difficulty: 'medium',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${dividend} √∑ ${divisor} = ${quotient}. Denn ${divisor} √ó ${quotient} = ${dividend}`
  };
}

// 10. Rechnen mit Geld (Euro und Cent)
function createMoneyTask2() {
  const euros = rnd(1, 5);
  const items = [
    { name: 'üç´ Schokolade', price: `${euros},50` },
    { name: 'ü•§ Saft', price: `${euros},00` },
    { name: 'üçé Apfel', price: '0,80' },
    { name: 'üç™ Kekse', price: `${euros},20` }
  ];
  
  const item = pick(items);
  const priceCents = Math.round(parseFloat(item.price.replace(',', '.')) * 100);
  const paid = Math.ceil(priceCents / 100) * 100 + rnd(0, 2) * 100;
  const change = paid - priceCents;
  
  const correct = (change / 100).toFixed(2).replace('.', ',');
  const wrong1 = ((change + 50) / 100).toFixed(2).replace('.', ',');
  const wrong2 = ((change - 50) / 100).toFixed(2).replace('.', ',');
  const wrong3 = ((change + 100) / 100).toFixed(2).replace('.', ',');
  
  return {
    problem: `Du kaufst: ${item.name} f√ºr ${item.price}‚Ç¨\n\nDu zahlst mit ${(paid/100).toFixed(2).replace('.', ',')}‚Ç¨\n\nWie viel R√ºckgeld?`,
    context: "Rechnen mit Euro",
    taskType: 'money',
    difficulty: 'medium',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `Du zahlst ${(paid/100).toFixed(2).replace('.', ',')}‚Ç¨ und es kostet ${item.price}‚Ç¨. R√ºckgeld: ${correct}‚Ç¨`
  };
}

// 11. Uhrzeit ablesen (volle und halbe Stunden, Viertelstunden)
function createTimeTask2() {
  const hour = rnd(1, 12);
  const minuteOptions = [0, 15, 30, 45];
  const minutes = pick(minuteOptions);
  
  let timeStr;
  if (minutes === 0) {
    timeStr = `${hour} Uhr`;
  } else if (minutes === 15) {
    timeStr = `Viertel nach ${hour}`;
  } else if (minutes === 30) {
    timeStr = `halb ${hour + 1}`;
  } else {
    timeStr = `Viertel vor ${hour + 1}`;
  }
  
  const correct = `${hour}:${minutes.toString().padStart(2, '0')}`;
  const wrong1 = `${hour + 1}:${minutes.toString().padStart(2, '0')}`;
  const wrong2 = `${hour}:${(minutes + 15) % 60}`;
  const wrong3 = `${hour}:${(minutes === 0 ? 30 : 0).toString().padStart(2, '0')}`;
  
  return {
    problem: `Wie sp√§t ist es?\n\nüïê ${timeStr}`,
    context: "Uhrzeit ablesen",
    taskType: 'time',
    difficulty: minutes === 30 ? 'medium' : 'easy',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${timeStr} = ${correct} Uhr. ${minutes === 30 ? `"halb ${hour + 1}" bedeutet 30 Minuten nach ${hour} Uhr` : ''}`
  };
}

// 12. Gr√∂√üer/Kleiner/Gleich bis 100
function createComparisonTask2() {
  const a = rnd(20, 99);
  const b = rnd(20, 99);
  
  while (Math.abs(a - b) < 5) {
    b = rnd(20, 99);
  }
  
  const larger = Math.max(a, b);
  const smaller = Math.min(a, b);
  
  const questions = [
    { q: 'Welche Zahl ist gr√∂√üer?', correct: larger },
    { q: 'Welche Zahl ist kleiner?', correct: smaller }
  ];
  
  const question = pick(questions);
  const correct = question.correct;
  
  return {
    problem: `${a}  und  ${b}\n\n${question.q}`,
    context: "Zahlen vergleichen",
    taskType: 'comparison',
    difficulty: 'easy',
    correctAnswer: correct,
    options: shuffle([correct, correct === larger ? smaller : larger, correct + 5, correct - 5]),
    explanation: `${larger} > ${smaller}. ${larger} ist gr√∂√üer als ${smaller}.`
  };
}

// ==================== KLASSE 3: Zahlenraum bis 1000 ====================
// Curriculum: Zahlen bis 1000, schriftliche Addition/Subtraktion, Einmaleins festigen, Division mit Rest, L√§ngen, Gewichte

// 13. Addition bis 1000
function createAdditionTask3() {
  const a = rnd(100, 850);
  const b = rnd(50, 300);
  const sum = a + b;
  
  if (sum > 1000) {
    return createAdditionTask3();
  }
  
  const correct = sum;
  const wrong1 = sum + 100;
  const wrong2 = sum - 100;
  const wrong3 = a - b;
  
  return {
    problem: `${a} + ${b} = ?`,
    context: "Addition bis 1000",
    taskType: 'addition',
    difficulty: 'medium',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${a} + ${b} = ${sum}. Tipp: Rechne stellenweise (Hunderter + Hunderter, Zehner + Zehner, Einer + Einer)`
  };
}

// 14. Subtraktion bis 1000
function createSubtractionTask3() {
  const a = rnd(200, 999);
  const b = rnd(50, a - 50);
  const diff = a - b;
  
  const correct = diff;
  const wrong1 = diff + 100;
  const wrong2 = diff - 100;
  const wrong3 = a + b;
  
  return {
    problem: `${a} ‚àí ${b} = ?`,
    context: "Subtraktion bis 1000",
    taskType: 'subtraction',
    difficulty: 'medium',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${a} ‚àí ${b} = ${diff}. Zur Probe: ${diff} + ${b} = ${a} ‚úì`
  };
}

// 15. Einmaleins festigen (alle Reihen)
function createMultiplicationTask3() {
  const factor1 = rnd(2, 10);
  const factor2 = rnd(2, 10);
  const product = factor1 * factor2;
  
  const correct = product;
  const wrong1 = product + factor1;
  const wrong2 = product - factor1;
  const wrong3 = factor1 + factor2;
  
  return {
    problem: `${factor1} √ó ${factor2} = ?`,
    context: `Einmaleins: ${factor1}er-Reihe`,
    taskType: 'multiplication',
    difficulty: 'medium',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${factor1} √ó ${factor2} = ${product}. Das kleine Einmaleins solltest du auswendig k√∂nnen!`
  };
}

// 16. Division mit Rest
function createDivisionWithRestTask3() {
  const divisor = rnd(3, 9);
  const quotient = rnd(3, 12);
  const remainder = rnd(1, divisor - 1);
  const dividend = divisor * quotient + remainder;
  
  const correct = `${quotient} Rest ${remainder}`;
  const wrong1 = `${quotient + 1} Rest ${remainder}`;
  const wrong2 = `${quotient} Rest ${remainder + 1}`;
  const wrong3 = `${quotient} Rest 0`;
  
  return {
    problem: `${dividend} √∑ ${divisor} = ?`,
    context: "Division mit Rest",
    taskType: 'division_rest',
    difficulty: 'hard',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${dividend} √∑ ${divisor} = ${quotient} Rest ${remainder}. Probe: ${divisor} √ó ${quotient} + ${remainder} = ${dividend}`
  };
}

// 17. L√§ngen umrechnen (m, cm)
function createLengthTask3() {
  const meters = rnd(2, 9);
  const cm = rnd(10, 90);
  
  const type = Math.random() < 0.5 ? 'to_cm' : 'to_m';
  
  if (type === 'to_cm') {
    const correct = meters * 100;
    const wrong1 = meters * 10;
    const wrong2 = meters * 100 + 10;
    const wrong3 = meters + 100;
    
    return {
      problem: `${meters} m = ? cm`,
      context: "L√§ngen: Meter ‚Üí Zentimeter",
      taskType: 'length',
      difficulty: 'medium',
      correctAnswer: correct,
      options: shuffle([correct, wrong1, wrong2, wrong3]),
      explanation: `1 m = 100 cm, also ${meters} m = ${meters} √ó 100 = ${correct} cm`
    };
  } else {
    const totalCm = meters * 100 + cm;
    const correct = `${meters} m ${cm} cm`;
    const wrong1 = `${meters + 1} m ${cm} cm`;
    const wrong2 = `${meters} m ${cm + 10} cm`;
    const wrong3 = `${Math.floor(totalCm / 10)} m ${totalCm % 10} cm`;
    
    return {
      problem: `${totalCm} cm = ? m ? cm`,
      context: "L√§ngen: Zentimeter ‚Üí Meter",
      taskType: 'length',
      difficulty: 'hard',
      correctAnswer: correct,
      options: shuffle([correct, wrong1, wrong2, wrong3]),
      explanation: `100 cm = 1 m. ${totalCm} cm = ${meters} m und ${cm} cm`
    };
  }
}

// 18. Gewichte (kg, g)
function createWeightTask3() {
  const kg = rnd(2, 9);
  
  const correct = kg * 1000;
  const wrong1 = kg * 100;
  const wrong2 = kg * 1000 + 100;
  const wrong3 = kg + 1000;
  
  return {
    problem: `${kg} kg = ? g`,
    context: "Gewichte: Kilogramm ‚Üí Gramm",
    taskType: 'weight',
    difficulty: 'medium',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `1 kg = 1000 g, also ${kg} kg = ${kg} √ó 1000 = ${correct} g`
  };
}

// 19. Geometrie: Umfang
function createPerimeterTask3() {
  const length = rnd(5, 15);
  const width = rnd(3, 10);
  const perimeter = 2 * (length + width);
  
  const correct = perimeter;
  const wrong1 = length + width;
  const wrong2 = length * width;
  const wrong3 = perimeter + 2;
  
  return {
    problem: `Ein Rechteck ist ${length} cm lang und ${width} cm breit.\n\nWie lang ist der Umfang?`,
    context: "Geometrie: Umfang",
    taskType: 'perimeter',
    difficulty: 'medium',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `Umfang = 2 √ó (L√§nge + Breite) = 2 √ó (${length} + ${width}) = 2 √ó ${length + width} = ${perimeter} cm`
  };
}

// 20. Sachaufgabe mit 2 Schritten
function createTwoStepTask3() {
  const boxes = rnd(3, 6);
  const itemsPerBox = rnd(4, 8);
  const pricePerItem = rnd(2, 5);
  
  const totalItems = boxes * itemsPerBox;
  const totalPrice = totalItems * pricePerItem;
  
  const correct = totalPrice;
  const wrong1 = totalItems;
  const wrong2 = boxes * pricePerItem;
  const wrong3 = totalPrice + 10;
  
  return {
    problem: `${boxes} Kisten mit je ${itemsPerBox} Stiften.\nEin Stift kostet ${pricePerItem}‚Ç¨.\n\nWie viel kosten alle Stifte zusammen?`,
    context: "Sachaufgabe (2 Schritte)",
    taskType: 'word_problem',
    difficulty: 'hard',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `Schritt 1: ${boxes} √ó ${itemsPerBox} = ${totalItems} Stifte. Schritt 2: ${totalItems} √ó ${pricePerItem}‚Ç¨ = ${totalPrice}‚Ç¨`
  };
}

// ==================== KLASSE 4: Zahlenraum bis 1.000.000 ====================
// Curriculum: Zahlen bis 1 Million, schriftliche Multiplikation/Division, Br√ºche, Dezimalzahlen (Einf√ºhrung)

// 21. Gro√üe Zahlen lesen und schreiben
function createLargeNumberTask4() {
  const thousand = rnd(10, 999);
  const number = thousand * 1000 + rnd(0, 999);
  
  const correct = number;
  const wrong1 = number + 1000;
  const wrong2 = number - 1000;
  const wrong3 = thousand * 100 + rnd(0, 999);
  
  const questions = [
    { q: `${thousand} Tausend = ?`, answer: thousand * 1000 },
    { q: `Wie viele Tausender hat ${number}?`, answer: Math.floor(number / 1000) }
  ];
  
  const question = pick(questions);
  const correctAns = question.answer;
  const wrong1Ans = correctAns + 10;
  const wrong2Ans = correctAns - 10;
  const wrong3Ans = correctAns * 10;
  
  return {
    problem: question.q,
    context: "Gro√üe Zahlen",
    taskType: 'large_numbers',
    difficulty: 'medium',
    correctAnswer: correctAns,
    options: shuffle([correctAns, wrong1Ans, wrong2Ans, wrong3Ans]),
    explanation: `${question.q} = ${correctAns}. Tipp: 1000 = 1 Tausend, 10.000 = 10 Tausend`
  };
}

// 22. Schriftliche Multiplikation (zweistellig √ó einstellig)
function createMultiplicationTask4() {
  const factor1 = rnd(12, 99);
  const factor2 = rnd(2, 9);
  const product = factor1 * factor2;
  
  const correct = product;
  const wrong1 = factor1 + factor2;
  const wrong2 = product + factor1;
  const wrong3 = product - factor2;
  
  return {
    problem: `${factor1} √ó ${factor2} = ?`,
    context: "Schriftlich multiplizieren",
    taskType: 'multiplication',
    difficulty: 'hard',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${factor1} √ó ${factor2} = ${product}. Rechne schriftlich: Erst Einer, dann Zehner mit dem Faktor multiplizieren.`
  };
}

// 23. Schriftliche Division (durch einstellige Zahlen)
function createDivisionTask4() {
  const divisor = rnd(2, 9);
  const quotient = rnd(12, 99);
  const dividend = divisor * quotient;
  
  const correct = quotient;
  const wrong1 = quotient + 10;
  const wrong2 = quotient - 10;
  const wrong3 = dividend - divisor;
  
  return {
    problem: `${dividend} √∑ ${divisor} = ?`,
    context: "Schriftlich dividieren",
    taskType: 'division',
    difficulty: 'hard',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${dividend} √∑ ${divisor} = ${quotient}. Probe: ${quotient} √ó ${divisor} = ${dividend} ‚úì`
  };
}

// 24. Br√ºche (H√§lfte, Drittel, Viertel)
function createFractionTask4() {
  const fractions = [
    { name: 'die H√§lfte', divisor: 2, text: '1/2' },
    { name: 'ein Drittel', divisor: 3, text: '1/3' },
    { name: 'ein Viertel', divisor: 4, text: '1/4' }
  ];
  
  const fraction = pick(fractions);
  const whole = rnd(2, 8) * fraction.divisor;
  const result = whole / fraction.divisor;
  
  const correct = result;
  const wrong1 = result + 1;
  const wrong2 = result - 1;
  const wrong3 = whole - result;
  
  return {
    problem: `${fraction.text} von ${whole} = ?`,
    context: "Br√ºche berechnen",
    taskType: 'fractions',
    difficulty: 'medium',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${fraction.text} von ${whole}: ${whole} √∑ ${fraction.divisor} = ${result}. ${fraction.name} bedeutet durch ${fraction.divisor} teilen.`
  };
}

// 25. Dezimalzahlen (Einf√ºhrung: Euro und Cent)
function createDecimalTask4() {
  const euros = rnd(5, 20);
  const cents = rnd(1, 9) * 10;
  
  const decimalPrice = `${euros},${cents.toString().padStart(2, '0')}`;
  const totalCents = euros * 100 + cents;
  
  const correct = totalCents;
  const wrong1 = totalCents + 10;
  const wrong2 = totalCents - 10;
  const wrong3 = euros + cents;
  
  return {
    problem: `${decimalPrice}‚Ç¨ = ? Cent`,
    context: "Dezimalzahlen: Euro ‚Üí Cent",
    taskType: 'decimals',
    difficulty: 'medium',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${decimalPrice}‚Ç¨ = ${euros}‚Ç¨ und ${cents} Cent = ${totalCents} Cent (1‚Ç¨ = 100 Cent)`
  };
}

// 26. Runden auf Zehner, Hunderter, Tausender
function createRoundingTask4() {
  const number = rnd(1345, 9876);
  
  const roundTypes = [
    { name: 'Zehner', divisor: 10 },
    { name: 'Hunderter', divisor: 100 },
    { name: 'Tausender', divisor: 1000 }
  ];
  
  const roundType = pick(roundTypes);
  const rounded = Math.round(number / roundType.divisor) * roundType.divisor;
  
  const correct = rounded;
  const wrong1 = Math.floor(number / roundType.divisor) * roundType.divisor;
  const wrong2 = Math.ceil(number / roundType.divisor) * roundType.divisor;
  const wrong3 = number;
  
  return {
    problem: `Runde ${number} auf ${roundType.name}`,
    context: "Runden",
    taskType: 'rounding',
    difficulty: 'medium',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `${number} auf ${roundType.name} gerundet = ${rounded}. Regel: 0-4 abrunden, 5-9 aufrunden.`
  };
}

// 27. Fl√§cheninhalt (Rechteck)
function createAreaTask4() {
  const length = rnd(8, 20);
  const width = rnd(5, 15);
  const area = length * width;
  
  const correct = area;
  const wrong1 = 2 * (length + width);
  const wrong2 = length + width;
  const wrong3 = area + 10;
  
  return {
    problem: `Ein Rechteck ist ${length} cm lang und ${width} cm breit.\n\nWie gro√ü ist die Fl√§che?`,
    context: "Geometrie: Fl√§cheninhalt",
    taskType: 'area',
    difficulty: 'medium',
    correctAnswer: area,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `Fl√§cheninhalt = L√§nge √ó Breite = ${length} cm √ó ${width} cm = ${area} cm¬≤`
  };
}

// 28. Sachaufgabe mit mehreren Schritten
function createComplexWordProblem4() {
  const people = rnd(3, 6);
  const ticketPrice = rnd(8, 15);
  const snackPrice = rnd(3, 6);
  
  const ticketTotal = people * ticketPrice;
  const snackTotal = people * snackPrice;
  const grandTotal = ticketTotal + snackTotal;
  
  const correct = grandTotal;
  const wrong1 = ticketTotal;
  const wrong2 = ticketTotal + snackPrice;
  const wrong3 = grandTotal - 5;
  
  return {
    problem: `${people} Personen gehen ins Kino.\nEin Ticket kostet ${ticketPrice}‚Ç¨.\nSnacks kosten ${snackPrice}‚Ç¨ pro Person.\n\nWie viel zahlen sie insgesamt?`,
    context: "Sachaufgabe (mehrere Schritte)",
    taskType: 'word_problem',
    difficulty: 'hard',
    correctAnswer: correct,
    options: shuffle([correct, wrong1, wrong2, wrong3]),
    explanation: `Tickets: ${people} √ó ${ticketPrice}‚Ç¨ = ${ticketTotal}‚Ç¨. Snacks: ${people} √ó ${snackPrice}‚Ç¨ = ${snackTotal}‚Ç¨. Gesamt: ${ticketTotal}‚Ç¨ + ${snackTotal}‚Ç¨ = ${grandTotal}‚Ç¨`
  };
}

// ==================== HAUPTGENERATOR ====================

function createTask(grade) {
  let taskGenerators = [];
  
  switch(grade) {
    case 1:
      // Zahlenraum bis 20: Addition, Subtraktion, Verdoppeln/Halbieren, Zerlegen, Vergleichen
      taskGenerators = [
        createAdditionTask1,
        createAdditionTask1,  // H√§ufiger
        createSubtractionTask1,
        createSubtractionTask1,  // H√§ufiger
        createDoublingTask1,
        createDecompositionTask1,
        createComparisonTask1
      ];
      break;
      
    case 2:
      // Zahlenraum bis 100: Addition, Subtraktion, Einmaleins (2,5,10 Reihen), Geld, Uhrzeit
      taskGenerators = [
        createAdditionTask2,
        createSubtractionTask2,
        createMultiplicationTask2,
        createMultiplicationTask2,  // H√§ufiger (Einmaleins √ºben!)
        createDivisionTask2,
        createMoneyTask2,
        createTimeTask2,
        createComparisonTask2
      ];
      break;
      
    case 3:
      // Zahlenraum bis 1000: Alle 4 Grundrechenarten, Einmaleins festigen, Gr√∂√üen
      taskGenerators = [
        createAdditionTask3,
        createSubtractionTask3,
        createMultiplicationTask3,
        createMultiplicationTask3,  // H√§ufiger (Einmaleins festigen!)
        createDivisionWithRestTask3,
        createLengthTask3,
        createWeightTask3,
        createPerimeterTask3,
        createTwoStepTask3
      ];
      break;
      
    case 4:
      // Zahlenraum bis 1 Million: Schriftliche Verfahren, Br√ºche, Dezimalzahlen
      taskGenerators = [
        createLargeNumberTask4,
        createMultiplicationTask4,
        createDivisionTask4,
        createFractionTask4,
        createDecimalTask4,
        createRoundingTask4,
        createAreaTask4,
        createComplexWordProblem4
      ];
      break;
  }
  
  const generator = pick(taskGenerators);
  const task = generator();
  
  const correctIndex = task.options.findIndex(opt => 
    opt.toString() === task.correctAnswer.toString()
  );
  
  return {
    ...task,
    correctIndex: correctIndex,
    grade: grade
  };
}

// ==================== SCHRIFTLICHE RECHENVERFAHREN ====================

// Schriftliche Addition
function generateWrittenAddition(num1, num2, sum) {
  const str1 = String(num1);
  const str2 = String(num2);
  const maxLen = Math.max(str1.length, str2.length);
  
  const pad1 = str1.padStart(maxLen, ' ');
  const pad2 = str2.padStart(maxLen, ' ');
  
  let html = '<div style="background: var(--color-bg); padding: 20px; border-radius: var(--radius-md); margin: 20px 0;">';
  html += '<div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; color: var(--color-primary-dark);">üìù Schriftlich rechnen:</div>';
  html += '<div style="font-family: monospace; font-size: 1.3rem; line-height: 1.8; background: var(--color-surface); border: 2px solid var(--color-primary); border-radius: var(--radius-sm); padding: 16px; display: inline-block; min-width: 150px;">';
  
  // √úbertr√§ge berechnen
  let carries = [];
  let currentCarry = 0;
  
  for (let i = maxLen - 1; i >= 0; i--) {
    const d1 = pad1[i] === ' ' ? 0 : parseInt(pad1[i]);
    const d2 = pad2[i] === ' ' ? 0 : parseInt(pad2[i]);
    const digitSum = d1 + d2 + currentCarry;
    
    if (digitSum >= 10) {
      carries[i] = 1;
      currentCarry = 1;
    } else {
      carries[i] = 0;
      currentCarry = 0;
    }
  }
  
  // Zeige √úbertr√§ge
  html += '<div style="text-align: right; padding-right: 30px; color: var(--color-accent-dark); font-size: 0.9rem;">';
  for (let i = 0; i < maxLen; i++) {
    if (carries[i] === 1) {
      html += '<span style="font-weight: 700;">¬π</span>';
    } else {
      html += '<span style="visibility: hidden;">¬π</span>';
    }
  }
  html += '</div>';
  
  html += `<div style="text-align: right;">  ${pad1}</div>`;
  html += `<div style="text-align: right;">+ ${pad2}</div>`;
  html += `<div style="text-align: right; border-top: 2px solid var(--color-text); padding-top: 4px; margin-top: 4px; font-weight: 700; color: var(--color-success);">= ${sum}</div>`;
  html += '</div>';
  
  // Schrittweise Erkl√§rung
  html += '<div style="margin-top: 20px;">';
  html += '<strong style="color: var(--color-primary-dark);">Schritt f√ºr Schritt:</strong>';
  
  currentCarry = 0;
  let stepNum = 1;
  
  for (let i = maxLen - 1; i >= 0; i--) {
    const d1 = pad1[i] === ' ' ? 0 : parseInt(pad1[i]);
    const d2 = pad2[i] === ' ' ? 0 : parseInt(pad2[i]);
    const position = ['Einer', 'Zehner', 'Hunderter', 'Tausender'][maxLen - 1 - i];
    
    html += '<div style="padding: 12px; margin: 8px 0; background: var(--color-bg); border-left: 4px solid var(--color-primary); border-radius: var(--radius-sm);">';
    html += `<div style="font-weight: 600; color: var(--color-primary-dark); margin-bottom: 4px;">Schritt ${stepNum}: ${position}</div>`;
    html += '<div>';
    
    const digitSum = d1 + d2 + currentCarry;
    if (currentCarry > 0) {
      html += `${d1} + ${d2} + <span style="color: var(--color-accent-dark); font-weight: 600;">1</span> (√úbertrag) = `;
    } else {
      html += `${d1} + ${d2} = `;
    }
    
    if (digitSum >= 10) {
      html += `<span style="background: var(--color-accent); color: var(--color-surface); padding: 2px 6px; border-radius: 4px; font-weight: 600;">${digitSum}</span>`;
      html += ` ‚Üí Schreibe <strong>${digitSum % 10}</strong>, merke <strong>1</strong>`;
      currentCarry = 1;
    } else {
      html += `<span style="background: var(--color-success); color: var(--color-surface); padding: 2px 6px; border-radius: 4px; font-weight: 600;">${digitSum}</span>`;
      currentCarry = 0;
    }
    
    html += '</div></div>';
    stepNum++;
  }
  
  html += '</div></div>';
  return html;
}

// Schriftliche Subtraktion
function generateWrittenSubtraction(num1, num2, diff) {
  const str1 = String(num1);
  const str2 = String(num2);
  const maxLen = Math.max(str1.length, str2.length);
  
  const pad1 = str1.padStart(maxLen, ' ');
  const pad2 = str2.padStart(maxLen, ' ');
  
  let html = '<div style="background: var(--color-bg); padding: 20px; border-radius: var(--radius-md); margin: 20px 0;">';
  html += '<div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; color: var(--color-primary-dark);">üìù Schriftlich rechnen:</div>';
  html += '<div style="font-family: monospace; font-size: 1.3rem; line-height: 1.8; background: var(--color-surface); border: 2px solid var(--color-primary); border-radius: var(--radius-sm); padding: 16px; display: inline-block; min-width: 150px;">';
  
  // Berechne Borgen
  let borrows = [];
  let nums1 = pad1.split('').map(c => c === ' ' ? 0 : parseInt(c));
  
  for (let i = maxLen - 1; i >= 0; i--) {
    const d1 = nums1[i];
    const d2 = pad2[i] === ' ' ? 0 : parseInt(pad2[i]);
    
    if (d1 < d2) {
      borrows[i] = 1;
      nums1[i] += 10;
      if (i > 0) nums1[i - 1] -= 1;
    } else {
      borrows[i] = 0;
    }
  }
  
  // Zeige Borgen
  html += '<div style="text-align: right; padding-right: 30px; color: var(--color-error); font-size: 0.9rem;">';
  for (let i = 0; i < maxLen; i++) {
    if (borrows[i] === 1) {
      html += '<span style="font-weight: 700;">‚Åª¬π</span>';
    } else {
      html += '<span style="visibility: hidden;">‚Åª¬π</span>';
    }
  }
  html += '</div>';
  
  html += `<div style="text-align: right;">  ${pad1}</div>`;
  html += `<div style="text-align: right;">‚àí ${pad2}</div>`;
  html += `<div style="text-align: right; border-top: 2px solid var(--color-text); padding-top: 4px; margin-top: 4px; font-weight: 700; color: var(--color-success);">= ${diff}</div>`;
  html += '</div>';
  
  // Schrittweise Erkl√§rung
  html += '<div style="margin-top: 20px;">';
  html += '<strong style="color: var(--color-primary-dark);">Schritt f√ºr Schritt:</strong>';
  
  nums1 = pad1.split('').map(c => c === ' ' ? 0 : parseInt(c));
  let stepNum = 1;
  
  for (let i = maxLen - 1; i >= 0; i--) {
    let d1 = nums1[i];
    const d2 = pad2[i] === ' ' ? 0 : parseInt(pad2[i]);
    const position = ['Einer', 'Zehner', 'Hunderter', 'Tausender'][maxLen - 1 - i];
    
    html += '<div style="padding: 12px; margin: 8px 0; background: var(--color-bg); border-left: 4px solid var(--color-primary); border-radius: var(--radius-sm);">';
    html += `<div style="font-weight: 600; color: var(--color-primary-dark); margin-bottom: 4px;">Schritt ${stepNum}: ${position}</div>`;
    html += '<div>';
    
    if (d1 < d2) {
      html += `${d1} ist kleiner als ${d2} ‚Üí <span style="color: var(--color-error); font-weight: 600;">Borge 10</span> von der n√§chsten Stelle<br>`;
      html += `${d1} + 10 = ${d1 + 10}, dann ${d1 + 10} ‚àí ${d2} = <span style="background: var(--color-success); color: var(--color-surface); padding: 2px 6px; border-radius: 4px; font-weight: 600;">${d1 + 10 - d2}</span>`;
      if (i > 0) {
        nums1[i - 1] -= 1;
      }
    } else {
      html += `${d1} ‚àí ${d2} = <span style="background: var(--color-success); color: var(--color-surface); padding: 2px 6px; border-radius: 4px; font-weight: 600;">${d1 - d2}</span>`;
    }
    
    html += '</div></div>';
    stepNum++;
  }
  
  html += '</div></div>';
  return html;
}

// Schriftliche Multiplikation
function generateWrittenMultiplication(num1, num2, product) {
  const str1 = String(num1);
  const str2 = String(num2);
  
  let html = '<div style="background: var(--color-bg); padding: 20px; border-radius: var(--radius-md); margin: 20px 0;">';
  html += '<div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; color: var(--color-primary-dark);">üìù Schriftlich multiplizieren:</div>';
  
  // Wenn beide Zahlen mehrstellig sind, zeige Gittermethode
  if (str1.length >= 2 && str2.length >= 2) {
    html += generateGridMultiplication(num1, num2, product);
    html += '</div>';
    return html;
  }
  
  // Standard schriftliche Multiplikation
  html += '<div style="font-family: monospace; font-size: 1.3rem; line-height: 1.8; background: var(--color-surface); border: 2px solid var(--color-primary); border-radius: var(--radius-sm); padding: 16px; display: inline-block; min-width: 150px;">';
  
  html += `<div style="text-align: right;">  ${str1}</div>`;
  html += `<div style="text-align: right;">√ó ${str2}</div>`;
  html += `<div style="text-align: right; border-top: 2px solid var(--color-text); padding-top: 4px; margin-top: 4px; font-weight: 700; color: var(--color-success);">= ${product}</div>`;
  html += '</div>';
  
  // Schrittweise Erkl√§rung
  html += '<div style="margin-top: 20px;">';
  html += '<strong style="color: var(--color-primary-dark);">Schritt f√ºr Schritt:</strong>';
  
  if (str2.length === 1) {
    // Einstelliger Multiplikator
    let carry = 0;
    const multiplier = parseInt(str2);
    
    for (let i = str1.length - 1; i >= 0; i--) {
      const digit = parseInt(str1[i]);
      const position = ['Einer', 'Zehner', 'Hunderter'][str1.length - 1 - i];
      
      html += '<div style="padding: 12px; margin: 8px 0; background: var(--color-bg); border-left: 4px solid var(--color-primary); border-radius: var(--radius-sm);">';
      html += `<div style="font-weight: 600; color: var(--color-primary-dark); margin-bottom: 4px;">Schritt ${str1.length - i}: ${position}</div>`;
      html += '<div>';
      
      const prod = digit * multiplier + carry;
      
      if (carry > 0) {
        html += `${digit} √ó ${multiplier} + ${carry} (√úbertrag) = <span style="background: var(--color-accent); color: var(--color-surface); padding: 2px 6px; border-radius: 4px; font-weight: 600;">${prod}</span>`;
      } else {
        html += `${digit} √ó ${multiplier} = <span style="background: var(--color-accent); color: var(--color-surface); padding: 2px 6px; border-radius: 4px; font-weight: 600;">${prod}</span>`;
      }
      
      if (prod >= 10 && i > 0) {
        html += ` ‚Üí Schreibe <strong>${prod % 10}</strong>, merke <strong>${Math.floor(prod / 10)}</strong>`;
        carry = Math.floor(prod / 10);
      } else {
        carry = 0;
      }
      
      html += '</div></div>';
    }
  }
  
  html += '</div></div>';
  return html;
}

// Gittermethode f√ºr Multiplikation (wie im Bild)
function generateGridMultiplication(num1, num2, product) {
  const str1 = String(num1);
  const str2 = String(num2);
  
  let html = '<div style="margin: 20px 0;">';
  html += '<strong style="color: var(--color-primary-dark); font-size: 1.1rem;">üî¢ Gittermethode (K√§stchen-Rechnen):</strong>';
  html += '</div>';
  
  // Erstelle das Gitter
  html += '<div style="display: inline-block; background: var(--color-surface); border-radius: var(--radius-sm); padding: 10px; box-shadow: var(--shadow-sm);">';
  html += '<table style="border-collapse: collapse; font-family: monospace; font-size: 1.2rem;">';
  
  // Kopfzeile mit den Ziffern von num1
  html += '<tr><td style="padding: 12px; border: 2px solid var(--color-border); background: var(--color-bg);"></td>';
  for (let i = 0; i < str1.length; i++) {
    html += `<td style="padding: 12px; border: 2px solid var(--color-border); text-align: center; background: var(--color-primary-light); font-weight: 700; color: var(--color-primary-dark);">${str1[i]}</td>`;
  }
  html += '</tr>';
  
  // F√ºr jede Ziffer von num2
  for (let j = 0; j < str2.length; j++) {
    html += '<tr>';
    html += `<td style="padding: 12px; border: 2px solid var(--color-border); text-align: center; background: var(--color-primary-light); font-weight: 700; color: var(--color-primary-dark);">${str2[j]}</td>`;
    
    // F√ºr jede Ziffer von num1
    for (let i = 0; i < str1.length; i++) {
      const digit1 = parseInt(str1[i]);
      const digit2 = parseInt(str2[j]);
      const prod = digit1 * digit2;
      const tens = Math.floor(prod / 10);
      const ones = prod % 10;
      
      html += '<td style="padding: 0; border: 2px solid var(--color-border); width: 60px; height: 60px; position: relative; background: white;">';
      html += '<div style="position: relative; width: 100%; height: 100%;">';
      
      // Diagonale Linie
      html += '<svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;" viewBox="0 0 100 100" preserveAspectRatio="none">';
      html += '<line x1="0" y1="0" x2="100" y2="100" stroke="var(--color-border)" stroke-width="2"/>';
      html += '</svg>';
      
      // Zahlen
      html += '<div style="position: absolute; top: 4px; left: 8px; font-size: 1rem; color: var(--color-primary-dark); font-weight: 600;">' + (tens > 0 ? tens : '¬∑') + '</div>';
      html += '<div style="position: absolute; bottom: 4px; right: 8px; font-size: 1rem; color: var(--color-primary-dark); font-weight: 600;">' + ones + '</div>';
      html += '</div>';
      html += '</td>';
    }
    html += '</tr>';
  }
  
  html += '</table>';
  html += '</div>';
  
  // Erkl√§rung
  html += '<div style="margin-top: 24px;">';
  html += '<strong style="color: var(--color-primary-dark);">So funktioniert\'s:</strong>';
  html += '</div>';
  
  html += '<div style="padding: 12px; margin: 8px 0; background: var(--color-bg); border-left: 4px solid var(--color-primary); border-radius: var(--radius-sm);">';
  html += '<div style="font-weight: 600; color: var(--color-primary-dark); margin-bottom: 8px;">Schritt 1: Multiplizieren</div>';
  html += '<div>Jede Ziffer mit jeder multiplizieren. Die <strong>Zehner</strong> kommen oben links, die <strong>Einer</strong> unten rechts ins K√§stchen.</div>';
  html += '</div>';
  
  html += '<div style="padding: 12px; margin: 8px 0; background: var(--color-bg); border-left: 4px solid var(--color-primary); border-radius: var(--radius-sm);">';
  html += '<div style="font-weight: 600; color: var(--color-primary-dark); margin-bottom: 8px;">Schritt 2: Diagonal addieren</div>';
  html += '<div>Addiere die Zahlen entlang der Diagonalen (von rechts unten nach links oben). Bei √úbertrag zur n√§chsten Diagonale dazuz√§hlen.</div>';
  html += '</div>';
  
  html += '<div style="padding: 12px; margin: 8px 0; background: var(--color-success); color: white; border-radius: var(--radius-sm);">';
  html += `<div style="font-weight: 700; font-size: 1.1rem;">‚úì Ergebnis: ${num1} √ó ${num2} = ${product}</div>`;
  html += '</div>';
  
  html += '<div style="padding: 12px; margin-top: 12px; background: #e8f4f8; border-radius: var(--radius-sm); border-left: 4px solid #3498db;">';
  html += 'üí° <strong>Tipp:</strong> Die Gittermethode ist super f√ºr gro√üe Zahlen, weil du dir keine √úbertr√§ge merken musst!';
  html += '</div>';
  
  return html;
}

// Schriftliche Division (klassische deutsche Darstellung - verbessert)
function generateWrittenDivision(dividend, divisor, quotient, remainder = 0) {
  // Parse quotient if it contains "Rest"
  let actualQuotient = quotient;
  let actualRemainder = remainder;
  
  if (typeof quotient === 'string' && quotient.includes('Rest')) {
    const parts = quotient.split('Rest');
    actualQuotient = parseInt(parts[0].trim());
    actualRemainder = parseInt(parts[1].trim());
  }
  
  const dividendStr = String(dividend);
  
  let html = '<div style="background: var(--color-bg); padding: 20px; border-radius: var(--radius-md); margin: 20px 0;">';
  html += '<div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; color: var(--color-primary-dark);">üìù Schriftlich dividieren:</div>';
  
  // Hauptdarstellung
  html += '<div style="font-family: monospace; font-size: 1.4rem; line-height: 2; background: var(--color-surface); border: 2px solid var(--color-primary); border-radius: var(--radius-sm); padding: 20px; display: inline-block; min-width: 250px;">';
  
  // Kopfzeile
  html += `<div style="border-bottom: 2px solid var(--color-text); padding-bottom: 8px; margin-bottom: 12px; font-weight: 700;">`;
  html += `${dividend} : ${divisor} = <span style="color: var(--color-success);">${actualQuotient}</span>`;
  if (actualRemainder > 0) {
    html += ` <span style="color: var(--color-accent-dark);">Rest ${actualRemainder}</span>`;
  }
  html += `</div>`;
  
  // Berechne die Schritte
  let currentNumber = 0;
  let steps = [];
  
  for (let i = 0; i < dividendStr.length; i++) {
    currentNumber = currentNumber * 10 + parseInt(dividendStr[i]);
    
    if (currentNumber >= divisor) {
      const digit = Math.floor(currentNumber / divisor);
      const product = digit * divisor;
      const stepRemainder = currentNumber - product;
      
      steps.push({
        currentNumber,
        digit,
        product,
        remainder: stepRemainder,
        nextDigit: i < dividendStr.length - 1 ? dividendStr[i + 1] : null
      });
      
      currentNumber = stepRemainder;
    }
  }
  
  // Zeige die Rechnung untereinander
  for (let i = 0; i < steps.length; i++) {
    const step = steps[i];
    
    html += `<div style="margin: 12px 0; padding-left: ${i * 10}px;">`;
    
    if (i === 0) {
      html += `<div><span style="color: var(--color-text-light);">‚àí</span>${String(step.product).padStart(String(step.currentNumber).length, ' ')}</div>`;
    } else {
      html += `<div style="margin-bottom: 4px;">${step.currentNumber}</div>`;
      html += `<div><span style="color: var(--color-text-light);">‚àí</span>${String(step.product).padStart(String(step.currentNumber).length, ' ')}</div>`;
    }
    
    html += `<div style="border-top: 2px solid var(--color-text); display: inline-block; padding-top: 4px; margin-top: 2px;">`;
    
    if (step.nextDigit !== null) {
      // Zeige Rest und n√§chste Ziffer
      html += `<span style="font-weight: 700; color: var(--color-primary-dark);">${step.remainder}</span><span style="color: var(--color-accent);">${step.nextDigit}</span>`;
    } else if (step.remainder === 0) {
      html += `<span style="font-weight: 700; color: var(--color-success);">0</span>`;
    } else {
      html += `<span style="font-weight: 700; color: var(--color-accent-dark);">${step.remainder}</span>`;
    }
    
    html += `</div>`;
    html += `</div>`;
  }
  
  html += '</div>';
  
  // Schrittweise Erkl√§rung
  html += '<div style="margin-top: 24px;">';
  html += '<strong style="color: var(--color-primary-dark); font-size: 1.1rem;">Schritt f√ºr Schritt:</strong>';
  
  for (let i = 0; i < steps.length; i++) {
    const step = steps[i];
    
    html += '<div style="padding: 12px; margin: 8px 0; background: var(--color-bg); border-left: 4px solid var(--color-primary); border-radius: var(--radius-sm);">';
    html += `<div style="font-weight: 600; color: var(--color-primary-dark); margin-bottom: 8px;">Schritt ${i + 1}:</div>`;
    html += '<div style="line-height: 1.8;">';
    
    html += `<strong>${step.currentNumber} : ${divisor} = <span style="background: var(--color-accent); color: var(--color-surface); padding: 2px 8px; border-radius: 4px;">${step.digit}</span></strong><br>`;
    html += `Rechnung: ${step.digit} √ó ${divisor} = ${step.product}<br>`;
    html += `Subtraktion: ${step.currentNumber} ‚àí ${step.product} = ${step.remainder}`;
    
    if (step.nextDigit !== null) {
      html += `<br><small style="color: var(--color-primary-dark); font-weight: 600;">‚Üí Hole die n√§chste Ziffer (${step.nextDigit}) herunter ‚Üí ${step.remainder}${step.nextDigit}</small>`;
    }
    
    html += '</div></div>';
  }
  
  // Rest-Behandlung
  if (actualRemainder > 0 || steps[steps.length - 1].remainder > 0) {
    const finalRemainder = actualRemainder > 0 ? actualRemainder : steps[steps.length - 1].remainder;
    html += '<div style="padding: 12px; margin: 12px 0; background: #fff4e6; border-radius: var(--radius-sm); border-left: 4px solid var(--color-accent);">';
    html += `<strong style="color: var(--color-accent-dark);">üìå Es bleibt ein Rest von ${finalRemainder}</strong><br>`;
    html += `Das bedeutet: ${dividend} = ${actualQuotient} √ó ${divisor} + ${finalRemainder}`;
    html += '</div>';
  }
  
  // Probe
  html += '<div style="padding: 12px; margin: 12px 0; background: var(--color-success); color: white; border-radius: var(--radius-sm);">';
  html += '<div style="font-weight: 700; margin-bottom: 4px;">‚úì Probe:</div>';
  html += `${actualQuotient} √ó ${divisor}`;
  if (actualRemainder > 0) {
    html += ` + ${actualRemainder}`;
  }
  html += ` = ${dividend} ‚úì`;
  html += '</div>';
  
  html += '</div></div>';
  return html;
}

// ==================== ERKL√ÑRUNGSFUNKTION ====================

function generateExplanation(task) {
  const difficultyBadge = task.difficulty === 'easy' ? 'difficulty-easy' : 
                          task.difficulty === 'medium' ? 'difficulty-medium' : 
                          'difficulty-hard';
  
  const difficultyText = task.difficulty === 'easy' ? 'Leicht' : 
                         task.difficulty === 'medium' ? 'Mittel' : 
                         'Schwer';
  
  let html = `
    <div class="difficulty-badge ${difficultyBadge}">${difficultyText}</div>
    <p style="margin-bottom: 16px;"><strong>Aufgabe:</strong><br>${task.problem.replace(/\n/g, '<br>')}</p>
    <p style="margin-bottom: 16px;"><strong>‚úì Richtige Antwort:</strong> ${task.correctAnswer}</p>
  `;
  
  // F√ºge schriftliches Rechnen hinzu, wenn angebracht
  
  if (task.taskType === 'addition') {
    const matches = task.problem.match(/(\d+)\s*\+\s*(\d+)/);
    if (matches && task.grade >= 3) {
      const num1 = parseInt(matches[1]);
      const num2 = parseInt(matches[2]);
      if (num1 >= 20 || num2 >= 20) {
        html += generateWrittenAddition(num1, num2, task.correctAnswer);
      }
    }
  } else if (task.taskType === 'subtraction') {
    const matches = task.problem.match(/(\d+)\s*‚àí\s*(\d+)/);
    if (matches && task.grade >= 3) {
      const num1 = parseInt(matches[1]);
      const num2 = parseInt(matches[2]);
      if (num1 >= 20) {
        html += generateWrittenSubtraction(num1, num2, task.correctAnswer);
      }
    }
  } else if (task.taskType === 'multiplication') {
    const matches = task.problem.match(/(\d+)\s*√ó\s*(\d+)/);
    if (matches) {
      const num1 = parseInt(matches[1]);
      const num2 = parseInt(matches[2]);
      // Zeige schriftliches Rechnen ab Klasse 3 f√ºr gr√∂√üere Zahlen
      if (task.grade >= 3 && (num1 >= 11 || num2 >= 11)) {
        html += generateWrittenMultiplication(num1, num2, task.correctAnswer);
      }
    }
  } else if (task.taskType === 'division' || task.taskType === 'division_rest') {
    const matches = task.problem.match(/(\d+)\s*√∑\s*(\d+)/);
    if (matches && task.grade >= 3) {
      const num1 = parseInt(matches[1]);
      const num2 = parseInt(matches[2]);
      if (num1 >= 20) {
        html += generateWrittenDivision(num1, num2, task.correctAnswer);
      }
    }
  }
  
  html += `<p><strong>üí° Erkl√§rung:</strong><br>${task.explanation}</p>`;
  
  return html;
}

// ==================== STATE MANAGEMENT ====================

function saveState() {
  try {
    localStorage.setItem('mathState', JSON.stringify({
      grade: state.grade,
      score: state.score,
      total: state.total,
      streak: state.streak,
      maxStreak: state.maxStreak,
      history: state.history.slice(-50),
      settings: state.settings
    }));
  } catch (e) {
    console.error('Save failed:', e);
  }
}

function loadState() {
  try {
    const saved = localStorage.getItem('mathState');
    if (saved) {
      const data = JSON.parse(saved);
      state.grade = data.grade || 1;
      state.score = data.score || 0;
      state.total = data.total || 0;
      state.streak = data.streak || 0;
      state.maxStreak = data.maxStreak || 0;
      state.history = data.history || [];
      state.settings = { ...state.settings, ...data.settings };
      
      $('grades').querySelectorAll('button').forEach(b => {
        b.classList.toggle('on', +b.dataset.g === state.grade);
      });
      
      $('snd').textContent = state.settings.sound ? 'üîä' : 'üîá';
    }
  } catch (e) {
    console.error('Load failed:', e);
  }
}

// ==================== SPRACHAUSGABE ====================

function speak(text) {
  if (!state.settings.sound || !speechSynthesis) return;
  speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'de-DE';
  utterance.rate = 0.85;
  if (state.voice) utterance.voice = state.voice;
  speechSynthesis.speak(utterance);
}

speechSynthesis.onvoiceschanged = () => {
  state.voice = speechSynthesis.getVoices().find(v => v.lang.startsWith('de')) || null;
};

// ==================== TIMER ====================

function startTimer() {
  if (!state.settings.timer) return;
  stopTimer();
  state.timerValue = 30;
  $('timer').style.display = 'block';
  $('time').textContent = state.timerValue;
  $('timer').classList.remove('warning');
  
  state.timerInterval = setInterval(() => {
    state.timerValue--;
    $('time').textContent = state.timerValue;
    
    if (state.timerValue <= 10) {
      $('timer').classList.add('warning');
    }
    
    if (state.timerValue <= 0) {
      stopTimer();
      if (!state.answered) {
        answerQuestion(-1);
        $('msg').textContent = '‚è±Ô∏è Zeit abgelaufen!';
      }
    }
  }, 1000);
}

function stopTimer() {
  if (state.timerInterval) {
    clearInterval(state.timerInterval);
    state.timerInterval = null;
  }
  if (state.settings.timer) {
    $('timer').style.display = 'none';
  }
}

// ==================== UI UPDATES ====================

function updateStats() {
  $('score').textContent = state.score;
  $('total').textContent = state.total;
  $('streak').textContent = state.streak;
}

function updateHistory() {
  const html = state.history.slice(-5).reverse().map(item => 
    `<div class="history-item ${item.correct ? 'ok' : 'no'}">${item.problem}</div>`
  ).join('');
  $('history').innerHTML = html || '<div style="text-align:center;opacity:0.6;padding:10px;">Noch keine Aufgaben</div>';
}

function showHistoryModal() {
  const accuracy = state.total > 0 ? Math.round((state.score / state.total) * 100) : 0;
  const html = `
    <div class="settings-panel">
      <div class="setting-row">
        <div class="setting-label">Gesamt beantwortet</div>
        <div style="font-weight: 600; font-size: 1.2rem;">${state.total}</div>
      </div>
      <div class="setting-row">
        <div class="setting-label">Richtig</div>
        <div style="font-weight: 600; font-size: 1.2rem;">${state.score}</div>
      </div>
      <div class="setting-row">
        <div class="setting-label">Genauigkeit</div>
        <div style="font-weight: 600; font-size: 1.2rem;">${accuracy}%</div>
      </div>
      <div class="setting-row">
        <div class="setting-label">L√§ngste Serie</div>
        <div style="font-weight: 600; font-size: 1.2rem;">${state.maxStreak}</div>
      </div>
      <div class="setting-row">
        <div class="setting-label">Aktuelle Serie</div>
        <div style="font-weight: 600; font-size: 1.2rem;">${state.streak}</div>
      </div>
    </div>
    <div style="margin-top: 20px;">
      <strong style="margin-bottom: 12px; display: block;">Letzte Aufgaben:</strong>
      <div class="history">
        ${state.history.slice(-8).reverse().map(item => 
          `<div class="history-item ${item.correct ? 'ok' : 'no'}">${item.problem}</div>`
        ).join('') || '<div style="text-align:center;opacity:0.6;">Noch keine Aufgaben</div>'}
      </div>
    </div>
  `;
  $('mbody-history').innerHTML = html;
  $('ov-history').classList.add('show');
}

// ==================== AUFGABE STARTEN ====================

function startNewTask() {
  state.currentTask = createTask(state.grade);
  state.answered = false;
  
  let displayText = state.currentTask.problem;
  if (state.currentTask.context) {
    displayText = `<div class="task-context">${state.currentTask.context}</div>${displayText}`;
  }
  $('task').innerHTML = displayText.replace(/\n/g, '<br>');
  
  $('msg').className = 'msg';
  $('msg').textContent = 'W√§hle die richtige Antwort';
  $('help').disabled = false;
  
  $('ans').innerHTML = '';
  state.currentTask.options.forEach((option, index) => {
    const btn = document.createElement('button');
    btn.textContent = option;
    btn.onclick = () => answerQuestion(index);
    $('ans').appendChild(btn);
  });
  
  const spokenText = state.currentTask.problem
    .replace(/\n/g, '. ')
    .replace(/\+/g, ' plus ')
    .replace(/‚àí/g, ' minus ')
    .replace(/√ó/g, ' mal ')
    .replace(/√∑/g, ' geteilt durch ')
    .replace(/\?/g, '')
    .replace(/=/g, ' gleich ');
  
  speak(spokenText);
  startTimer();
}

// ==================== ANTWORT PR√úFEN ====================

function answerQuestion(selectedIndex) {
  if (state.answered) return;
  
  state.answered = true;
  stopTimer();
  
  const buttons = $('ans').querySelectorAll('button');
  const correctIndex = state.currentTask.correctIndex;
  
  buttons[correctIndex].classList.add('ok');
  
  const isCorrect = selectedIndex === correctIndex;
  state.total++;
  
  if (isCorrect) {
    state.score++;
    state.streak++;
    if (state.streak > state.maxStreak) {
      state.maxStreak = state.streak;
    }
    $('msg').className = 'msg ok';
    const encouragements = ['Super!', 'Richtig!', 'Toll gemacht!', 'Prima!', 'Klasse!'];
    $('msg').textContent = `‚úÖ ${pick(encouragements)}`;
    speak(`${pick(encouragements)} Das war richtig!`);
  } else {
    state.streak = 0;
    if (selectedIndex >= 0) {
      buttons[selectedIndex].classList.add('no');
    }
    $('msg').className = 'msg no';
    $('msg').textContent = `Die richtige Antwort ist: ${state.currentTask.correctAnswer}`;
    speak('Das war leider nicht richtig. Versuch es beim n√§chsten Mal noch einmal.');
  }
  
  let historyText = state.currentTask.problem.substring(0, 60);
  if (state.currentTask.problem.length > 60) historyText += '...';
  historyText += ` ‚Üí ${state.currentTask.correctAnswer}`;
  
  state.history.push({
    problem: historyText,
    correct: isCorrect
  });
  
  updateStats();
  updateHistory();
  saveState();
}

// ==================== EVENT LISTENERS ====================

$('grades').onclick = e => {
  const btn = e.target.closest('button[data-g]');
  if (!btn) return;
  
  state.grade = +btn.dataset.g;
  $('grades').querySelectorAll('button').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  saveState();
};

$('start').onclick = startNewTask;

$('help').onclick = () => {
  if (!state.currentTask) return;
  $('mbody-help').innerHTML = generateExplanation(state.currentTask);
  $('ov-help').classList.add('show');
};

$('history-btn').onclick = showHistoryModal;
$('history-btn-2').onclick = showHistoryModal;

$('snd').onclick = () => {
  state.settings.sound = !state.settings.sound;
  $('snd').textContent = state.settings.sound ? 'üîä' : 'üîá';
  $('toggle-sound').classList.toggle('on', state.settings.sound);
  saveState();
};

$('settings').onclick = () => {
  $('toggle-timer').classList.toggle('on', state.settings.timer);
  $('toggle-sound').classList.toggle('on', state.settings.sound);
  $('toggle-keys').classList.toggle('on', state.settings.keyboard);
  $('ov-settings').classList.add('show');
};

// Modal controls
['help', 'settings', 'history'].forEach(name => {
  $(`cls-${name}`).onclick = () => $(`ov-${name}`).classList.remove('show');
  $(`mok-${name}`).onclick = () => $(`ov-${name}`).classList.remove('show');
  $(`ov-${name}`).onclick = e => {
    if (e.target === $(`ov-${name}`)) {
      $(`ov-${name}`).classList.remove('show');
    }
  };
});

// Toggle controls
$('toggle-timer').onclick = () => {
  state.settings.timer = !state.settings.timer;
  $('toggle-timer').classList.toggle('on');
  if (!state.settings.timer) stopTimer();
  saveState();
};

$('toggle-sound').onclick = () => {
  state.settings.sound = !state.settings.sound;
  $('toggle-sound').classList.toggle('on');
  $('snd').textContent = state.settings.sound ? 'üîä' : 'üîá';
  saveState();
};

$('toggle-keys').onclick = () => {
  state.settings.keyboard = !state.settings.keyboard;
  $('toggle-keys').classList.toggle('on');
  saveState();
};

// Keyboard shortcuts
document.onkeydown = e => {
  if (!state.settings.keyboard) return;
  
  if (e.key === 'Escape') {
    ['help', 'settings', 'history'].forEach(name => {
      $(`ov-${name}`).classList.remove('show');
    });
    return;
  }
  
  if ($('ov-help').classList.contains('show') || 
      $('ov-settings').classList.contains('show') ||
      $('ov-history').classList.contains('show')) {
    return;
  }
  
  if (e.key === 'Enter') {
    $('start').click();
  } else if (e.key.toLowerCase() === 'e' && state.currentTask) {
    $('help').click();
  } else if ('1234'.includes(e.key)) {
    const btn = $('ans').querySelectorAll('button')[+e.key - 1];
    if (btn) btn.click();
  }
};

// ==================== INITIALISIERUNG ====================

loadState();
updateStats();
updateHistory();
</script>
</body>
</html>
